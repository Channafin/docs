<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Forensic Analysis Dashboard - Enhanced Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --color-primary: #3498db;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #16a085;
            --color-secondary: #95a5a6;
            --color-dark: #2c3e50;
            --color-light: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--color-dark) 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header .version-badge {
            position: absolute;
            top: 20px;
            right: 30px;
            background: var(--color-success);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
        }

        .shortcuts-help.active {
            display: block;
        }

        .shortcuts-help h3 {
            margin-bottom: 20px;
            color: var(--color-dark);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--color-light);
        }

        .shortcut-key {
            background: var(--color-dark);
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        .population-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--color-primary);
        }

        .stat-card.total { border-left-color: var(--color-dark); }
        .stat-card.amount { border-left-color: var(--color-success); }
        .stat-card.vendors { border-left-color: #8e44ad; }
        .stat-card.period { border-left-color: var(--color-warning); }
        .stat-card.reviewed { border-left-color: var(--color-info); }
        .stat-card.risk { border-left-color: var(--color-danger); }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #7f8c8d;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-dark);
        }

        .stat-subtext {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 3px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-light);
            background: white;
            padding: 10px 20px 0;
            border-radius: 12px 12px 0 0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--color-dark);
            border-bottom-color: var(--color-primary);
        }

        .tab:hover {
            color: #34495e;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 12px 12px;
            margin-top: -20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 450px;
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 15px;
        }

        canvas {
            max-height: 380px !important;
            width: 100% !important;
        }

        /* Vendor Table */
        .vendor-pivot {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .vendor-row {
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }

        .vendor-row:hover {
            background: #e8ecef;
        }

        .vendor-row td {
            padding: 12px;
            border-top: 1px solid #dee2e6;
            font-weight: 600;
        }

        .vendor-row .expand-icon {
            display: inline-block;
            width: 20px;
            transition: transform 0.2s;
        }

        .vendor-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .transaction-row {
            display: none;
            background: white;
        }

        .transaction-row.visible {
            display: table-row;
        }

        .transaction-row.selected {
            background: #e3f2fd;
            border-left: 4px solid var(--color-primary);
        }

        .transaction-row td {
            padding: 10px 12px 10px 40px;
            border-top: 1px solid #f1f3f5;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-green { background: var(--color-success); }
        .status-red { background: var(--color-danger); }
        .status-yellow { background: var(--color-warning); }
        .status-gray { background: var(--color-secondary); }
        .status-reclass { background: #8e44ad; }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-green {
            background: linear-gradient(135deg, var(--color-success) 0%, #229954 100%);
        }

        .btn-red {
            background: linear-gradient(135deg, var(--color-danger) 0%, #c0392b 100%);
        }

        .btn-yellow {
            background: linear-gradient(135deg, var(--color-warning) 0%, #e67e22 100%);
        }

        /* Forensic Alerts */
        .alert-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .alert-item {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item.high {
            background: #fee;
            border-left-color: var(--color-danger);
        }

        .alert-item.medium {
            background: #fff3cd;
            border-left-color: var(--color-warning);
        }

        .alert-item.low {
            background: #d1ecf1;
            border-left-color: var(--color-info);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--color-secondary);
        }

        .close:hover {
            color: var(--color-dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        .form-group textarea,
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        @media print {
            .controls, .tabs, .action-buttons, .shortcuts-help {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div>
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div id="shortcutsHelp" class="shortcuts-help">
        <span class="close" onclick="toggleShortcutsHelp()">&times;</span>
        <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Accept Transaction</span>
            <span class="shortcut-key">A</span>
        </div>
        <div class="shortcut-item">
            <span>Reject Transaction</span>
            <span class="shortcut-key">R</span>
        </div>
        <div class="shortcut-item">
            <span>Review Transaction</span>
            <span class="shortcut-key">Y</span>
        </div>
        <div class="shortcut-item">
            <span>Next Unreviewed</span>
            <span class="shortcut-key">N</span>
        </div>
        <div class="shortcut-item">
            <span>Previous Transaction</span>
            <span class="shortcut-key">P</span>
        </div>
        <div class="shortcut-item">
            <span>Open Detail Modal</span>
            <span class="shortcut-key">Space</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Help</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>

    <div class="header">
        <h1>CPA Forensic Analysis Dashboard - Enhanced Edition</h1>
        <p class="subtitle">Advanced Transaction Review System | Tampa Bay Trial Lawyers Association</p>
        <div class="version-badge">v7.0 Enhanced</div>
    </div>

    <div class="container">
        <!-- Population Statistics -->
        <div class="population-stats">
            <h2 style="margin-bottom: 20px; color: var(--color-dark);">Complete Transaction Population Overview</h2>
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-value" id="totalTransactions">-</div>
                    <div class="stat-subtext" id="transactionPeriod">Loading...</div>
                </div>
                <div class="stat-card amount">
                    <div class="stat-label">Total Amount</div>
                    <div class="stat-value" id="totalAmount">-</div>
                    <div class="stat-subtext" id="avgTransaction">Avg: -</div>
                </div>
                <div class="stat-card vendors">
                    <div class="stat-label">Unique Vendors</div>
                    <div class="stat-value" id="uniqueVendors">-</div>
                    <div class="stat-subtext" id="topVendor">Top: -</div>
                </div>
                <div class="stat-card period">
                    <div class="stat-label">Date Range</div>
                    <div class="stat-value" id="dateRange" style="font-size: 16px;">-</div>
                    <div class="stat-subtext" id="daysCovered">- days</div>
                </div>
                <div class="stat-card reviewed">
                    <div class="stat-label">Review Progress</div>
                    <div class="stat-value" id="reviewProgress">0%</div>
                    <div class="stat-subtext" id="reviewCount">0 of 0 reviewed</div>
                </div>
                <div class="stat-card risk">
                    <div class="stat-label">High Risk Items</div>
                    <div class="stat-value" id="highRiskCount">0</div>
                    <div class="stat-subtext" id="riskAmount">$0.00</div>
                </div>
                <div class="stat-card" style="border-left-color: #8e44ad;">
                    <div class="stat-label">Reclass to Revenue</div>
                    <div class="stat-value" id="reclassCount">0</div>
                    <div class="stat-subtext" id="reclassAmount">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('review')">‚úÖ Transaction Review</button>
            <button class="tab" onclick="switchTab('forensics')">üîç Forensic Insights</button>
            <button class="tab" onclick="switchTab('documents')">üìé Document Management</button>
            <button class="tab" onclick="switchTab('reports')">üìã Reports & Export</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>Upload Transaction File</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" value="2020-01-01">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" value="2025-12-31">
                </div>
                <button onclick="updateDashboard()">üîÑ Refresh Analysis</button>
                <button onclick="toggleShortcutsHelp()">‚å®Ô∏è Keyboard Shortcuts</button>
                <button onclick="exportReviewData()" style="background: #27ae60; color: white;">üíæ Export Reviews</button>
                <button onclick="importReviewData()" style="background: #e67e22; color: white;">üì• Import Reviews</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
            </div>

            <!-- Chart Filters -->
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <strong style="color: #34495e;">Filter Charts:</strong>
                    <button id="chartFilterAll" onclick="filterCharts('all')" style="background: #3498db; color: white; font-weight: bold;">All</button>
                    <button id="chartFilterGreen" onclick="filterCharts('green')" style="background: #d4edda; color: #155724;">‚úÖ Green (Mission)</button>
                    <button id="chartFilterRed" onclick="filterCharts('red')" style="background: #f8d7da; color: #721c24;">‚ùå Red (Non-mission)</button>
                    <button id="chartFilterYellow" onclick="filterCharts('yellow')" style="background: #fff3cd; color: #856404;">‚ö†Ô∏è Yellow (Review)</button>
                    <button id="chartFilterReclass" onclick="filterCharts('reclass')" style="background: #e8daef; color: #4a235a;">üîÑ Reclass</button>
                    <span style="margin-left: 20px; color: #95a5a6;">|</span>
                    <strong style="color: #34495e;">Type:</strong>
                    <button id="typeFilterAll" onclick="filterByType('all')" style="background: #3498db; color: white; font-weight: bold;">All</button>
                    <button id="typeFilterCC" onclick="filterByType('Credit Card')">üí≥ Credit Card</button>
                    <button id="typeFilterBank" onclick="filterByType('Bank')">üè¶ Bank</button>
                    <span style="margin-left: 20px; color: #95a5a6;">|</span>
                    <strong style="color: #34495e;">View:</strong>
                    <button id="viewQuarterly" onclick="setChartView('quarterly')" style="background: #3498db; color: white; font-weight: bold;">üìÖ Quarterly</button>
                    <button id="viewAnnual" onclick="setChartView('annual')">üìä Annual</button>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Review Status Distribution</span>
                        <div style="display: flex; gap: 5px;">
                            <button id="statusViewCurrent" onclick="toggleStatusView('current')" style="padding: 4px 8px; font-size: 11px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Current</button>
                            <button id="statusViewYearly" onclick="toggleStatusView('yearly')" style="padding: 4px 8px; font-size: 11px; background: #ecf0f1; color: #2c3e50; border: none; border-radius: 4px; cursor: pointer;">By Year</button>
                        </div>
                    </div>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Transaction Volume</div>
                    <canvas id="volumeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 10 Vendors by Amount</div>
                    <canvas id="vendorChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üìä Transaction Count by Group</div>
                    <canvas id="groupVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Review Tab -->
        <div id="review-tab" class="tab-content">
            <div class="controls">
                <input type="text" id="vendorSearch" placeholder="üîç Search vendors..." style="flex: 1;">
                <button onclick="openGroupManagementModal()" style="background: #9b59b6; color: white;">üè∑Ô∏è Manage Groups</button>
                <button onclick="selectAllVisible()">‚òëÔ∏è Select All</button>
                <button onclick="batchAccept()">‚úÖ Batch Accept</button>
                <button onclick="batchReject()">‚ùå Batch Reject</button>
            </div>

            <!-- Group Filters -->
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <strong style="color: #34495e;">Filter by Group:</strong>
                    <div id="groupFilterButtons">
                        <button id="groupFilterAll" onclick="filterByGroup('all')" style="background: #3498db; color: white; font-weight: bold;">All Groups</button>
                        <button id="groupFilterUngrouped" onclick="filterByGroup('ungrouped')" style="background: #95a5a6;">Ungrouped</button>
                    </div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="vendor-pivot" id="vendorTable">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 12px; text-align: left;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th style="padding: 12px; text-align: left;">Vendor / Transaction</th>
                            <th style="padding: 12px; text-align: center;">üè∑Ô∏è Group</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">Category</th>
                            <th style="padding: 12px; text-align: left;">üìù Notes</th>
                            <th style="padding: 12px; text-align: center;">üìé Docs</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorTableBody">
                        <tr><td colspan="9" style="text-align: center; padding: 40px; background: #f8f9fa;">
                            <div style="font-size: 18px; margin-bottom: 10px;">üìÅ Load Your Transaction Data</div>
                            <div>Use the <strong>Upload File</strong> button above</div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Forensic Insights Tab -->
        <div id="forensics-tab" class="tab-content">
            <div class="alert-panel">
                <h3 style="margin-bottom: 15px;">üö® Real-time Forensic Alerts</h3>
                <div id="forensicAlerts">
                    <p style="color: #7f8c8d;">Load transaction data to see forensic analysis</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Benford's Law Analysis</div>
                    <canvas id="benfordChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Payment Velocity (Transactions per Vendor)</div>
                    <canvas id="velocityChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Statistical Outliers</div>
                    <canvas id="outlierChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Duplicate Detection</div>
                    <div id="duplicateList" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Document Management Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìé Bulk PDF Upload & Matching</h3>
                <input type="file" id="bulkPdfUpload" multiple accept=".pdf" style="display: none;">
                <button onclick="document.getElementById('bulkPdfUpload').click()" style="margin: 10px 0;">üìÅ Select PDFs to Upload</button>
                <div id="pdfUploadStatus" style="margin-top: 10px;"></div>
            </div>

            <div class="alert-panel">
                <h3>üìä Document Status Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: #d4edda; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMatched">0</div>
                        <div>Matched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsUnmatched">0</div>
                        <div>Unmatched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMissing">0</div>
                        <div>Missing Documentation</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìã Generate Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <button onclick="exportAuditReport()">üìä Complete Audit Report</button>
                    <button onclick="exportManagementLetter()">üìù Management Letter</button>
                    <button onclick="exportExceptionReport()">üö® Exception Report Only</button>
                    <button onclick="exportComplianceReport()">‚úÖ Compliance Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Transaction Review</h2>
            <div id="modalTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

            <div class="form-group">
                <label>Review Decision</label>
                <select id="reviewDecision">
                    <option value="">-- Select Status --</option>
                    <option value="green">‚úÖ Green - Mission Related</option>
                    <option value="red">‚ùå Red - Non-mission/Suspicious</option>
                    <option value="yellow">‚ö†Ô∏è Yellow - Needs Further Review</option>
                    <option value="reclass">üîÑ Reclass to Revenue</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Category</label>
                <select id="reviewCategory">
                    <option value="">-- Select Category --</option>
                    <option value="verified">Verified with Documentation</option>
                    <option value="mission">Mission/Program Related</option>
                    <option value="authorized">Properly Authorized</option>
                    <option value="suspicious">Suspicious - Investigate</option>
                    <option value="duplicate">Duplicate Transaction</option>
                    <option value="personal">Personal/Non-Business</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Notes (Max 5000 characters)</label>
                <textarea id="reviewNotes" maxlength="5000" placeholder="Enter detailed review notes..."></textarea>
                <div style="text-align: right; font-size: 12px; color: #7f8c8d;">
                    <span id="charCount">0</span>/5000
                </div>
            </div>

            <div class="form-group">
                <label>üìé Supporting Documentation</label>
                <div id="modalAttachmentList" style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 40px;">
                    <em style="color: #95a5a6;">No documents attached</em>
                </div>
                <input type="file" id="modalPdfUpload" accept=".pdf" multiple style="display: none;">
                <button type="button" onclick="document.getElementById('modalPdfUpload').click()" style="background: var(--color-info); width: 100%;">
                    üìÅ Upload PDF Documents
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button onclick="openSplitModal()" style="background: #e67e22; color: white;">‚úÇÔ∏è Split Transaction</button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeModal()" style="background: var(--color-secondary);">Cancel</button>
                    <button onclick="saveReview()">üíæ Save Review</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Entry Generator Modal -->
    <div id="jeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJEModal()">&times;</span>
            <h2>üìù Generate Journal Entry</h2>

            <div id="jeTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

            <div class="form-group">
                <label>Journal Entry Type</label>
                <select id="jeType" onchange="updateJETemplate()">
                    <option value="reclass">Reclassification</option>
                    <option value="correction">Correction</option>
                    <option value="reversal">Reversal</option>
                    <option value="accrual">Accrual</option>
                </select>
            </div>

            <div class="form-group">
                <label>Debit Account</label>
                <input type="text" id="jeDebitAccount" placeholder="e.g., Program Expenses - Education">
            </div>

            <div class="form-group">
                <label>Credit Account</label>
                <input type="text" id="jeCreditAccount" placeholder="e.g., Office Supplies">
            </div>

            <div class="form-group">
                <label>Memo/Description</label>
                <textarea id="jeMemo" rows="2" placeholder="Auto-filled from transaction"></textarea>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h3 style="margin-bottom: 10px; font-size: 14px; color: var(--color-dark);">Preview</h3>
                <pre id="jePreview" style="font-family: 'Courier New', monospace; font-size: 13px; white-space: pre; overflow-x: auto;"></pre>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <div>
                    <button onclick="copyJEToClipboard()" style="background: var(--color-info);">üìã Copy to Clipboard</button>
                    <button onclick="downloadJEAsCSV()" style="background: var(--color-success);">üì• Download CSV</button>
                </div>
                <button onclick="closeJEModal()" style="background: var(--color-secondary);">Close</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <span class="close" onclick="closePdfPreview()">&times;</span>
            <h2 id="pdfPreviewTitle">üìÑ Document Preview</h2>
            <div id="pdfPreviewInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 13px;"></div>
            <div style="height: 600px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; background: #f5f5f5;">
                <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button onclick="downloadCurrentPdf()" style="background: var(--color-success);">üì• Download</button>
                <button onclick="closePdfPreview()" style="background: var(--color-secondary);">Close</button>
            </div>
        </div>
    </div>

    <!-- Group Management Modal -->
    <div id="groupManagementModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeGroupManagementModal()">&times;</span>
            <h2>üè∑Ô∏è Manage Vendor Groups</h2>
            <p style="color: #7f8c8d; margin: 10px 0;">Create groups to categorize your vendors (e.g., Office Supplies, Travel, Contractors)</p>

            <div style="margin: 20px 0;">
                <h3 style="color: #34495e; font-size: 16px; margin-bottom: 10px;">Create New Group</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newGroupName" placeholder="Group name (e.g., Office Supplies)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="color" id="newGroupColor" value="#3498db" title="Group color" style="width: 50px; height: 38px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <button onclick="createGroup()" style="background: var(--color-success); white-space: nowrap;">‚ûï Add Group</button>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #34495e; font-size: 16px; margin-bottom: 10px;">Existing Groups</h3>
                <div id="groupsList" style="max-height: 300px; overflow-y: auto;">
                    <em style="color: #95a5a6;">No groups created yet</em>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeGroupManagementModal()" style="background: var(--color-secondary);">Close</button>
            </div>
        </div>
    </div>

    <!-- Split Transaction Modal -->
    <div id="splitModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeSplitModal()">&times;</span>
            <h2>‚úÇÔ∏è Split Transaction</h2>
            <p style="color: #7f8c8d; margin: 10px 0;">Break this transaction into multiple parts (e.g., partially mission-related, partially not)</p>

            <div id="splitTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px;"></div>

            <div style="margin: 20px 0;">
                <h3 style="color: #34495e; font-size: 16px; margin-bottom: 10px;">Split Parts</h3>
                <div id="splitPartsList" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Split parts will be added here -->
                </div>

                <button onclick="addSplitPart()" style="background: var(--color-success); margin-top: 15px; width: 100%;">
                    ‚ûï Add Split Part
                </button>
            </div>

            <div style="padding: 15px; background: #ecf0f1; border-radius: 6px; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Original Amount:</strong>
                    <span id="splitOriginalAmount">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <strong>Split Total:</strong>
                    <span id="splitTotal" style="font-weight: bold;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <strong>Remaining:</strong>
                    <span id="splitRemaining" style="font-weight: bold;">$0.00</span>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button onclick="removeSplits()" style="background: var(--color-danger);">üóëÔ∏è Remove All Splits</button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeSplitModal()" style="background: var(--color-secondary);">Cancel</button>
                    <button onclick="saveSplits()" style="background: var(--color-success);">üíæ Save Splits</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================================================
    // GLOBAL ERROR HANDLER
    // ============================================================================
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error:', msg, error);
        alert('An error occurred. Please save your work and refresh if needed.');
        return false;
    };

    // ============================================================================
    // SECURITY: HTML ESCAPE FUNCTION
    // ============================================================================
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ============================================================================
    // SAFE LOCALSTORAGE OPERATIONS
    // ============================================================================
    function safeLocalStorageSet(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('localStorage save failed:', e);
            if (e.name === 'QuotaExceededError') {
                alert('Storage is full. Please export your data and clear old reviews.');
            } else {
                alert('Unable to save data. Storage may be disabled.');
            }
            return false;
        }
    }

    function safeLocalStorageGet(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('localStorage read failed:', e);
            return defaultValue;
        }
    }

    // ============================================================================
    // LOADING SPINNER
    // ============================================================================
    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        overlay.classList.add('active');
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('active');
    }

    // ============================================================================
    // KEYBOARD SHORTCUTS
    // ============================================================================
    function toggleShortcutsHelp() {
        const help = document.getElementById('shortcutsHelp');
        help.classList.toggle('active');
    }

    document.addEventListener('keydown', function(e) {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }

        const key = e.key.toLowerCase();

        if (key === '?') {
            toggleShortcutsHelp();
        } else if (key === 'a' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'green', e);
        } else if (key === 'r' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'red', e);
        } else if (key === 'y' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'yellow', e);
        } else if (key === 'n') {
            navigateToNext(true);
        } else if (key === 'p') {
            navigateToPrevious();
        } else if (key === ' ' && currentSelectedTransaction) {
            e.preventDefault();
            openReviewModal(currentSelectedTransaction, e);
        }
    });

    // ============================================================================
    // GLOBAL VARIABLES
    // ============================================================================
    let allData = [];
    let vendorGroups = {};
    let reviewState = {};
    let charts = {};
    let currentTransactionId = null;
    let currentSelectedTransaction = null;
    let pdfAttachments = {};
    let chartView = 'quarterly';
    let currentChartFilter = 'all';
    let currentTypeFilter = 'all';
    let periodVendorData = {};
    let vendorGroupDefinitions = {}; // {groupId: {name: 'Travel', color: '#3498db'}}
    let vendorGroupAssignments = {}; // {vendorName: 'groupId'}
    let currentGroupFilter = 'all';
    let vendorNotes = {}; // {vendorName: 'note text'}
    let statusView = 'current'; // 'current' or 'yearly'

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    window.onload = function() {
        reviewState = safeLocalStorageGet('cpaForensicReviewState', {});
        pdfAttachments = safeLocalStorageGet('pdfAttachments', {});
        vendorNotes = safeLocalStorageGet('vendorNotes', {});
        loadVendorGroupsFromStorage();
        updateGroupFilterButtons();

        // Set up PDF upload handler
        const bulkUpload = document.getElementById('bulkPdfUpload');
        if (bulkUpload) {
            bulkUpload.addEventListener('change', handleBulkPdfUpload);
        }

        // Set up modal PDF upload handler
        const modalUpload = document.getElementById('modalPdfUpload');
        if (modalUpload) {
            modalUpload.addEventListener('change', handleModalPdfUpload);
        }

        // Character counter for notes
        const notesField = document.getElementById('reviewNotes');
        if (notesField) {
            notesField.addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
        }

        // Register Chart.js plugin properly
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            Chart.defaults.plugins.datalabels.display = false;
        }
    };

    // ============================================================================
    // FILE UPLOAD HANDLER
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                showLoading('Reading Excel file...');

                const reader = new FileReader();
                reader.onload = function(e) {
                    setTimeout(() => {
                        try {
                            showLoading('Processing transactions...');
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});

                            let worksheet;
                            if (workbook.Sheets['Clean']) {
                                worksheet = workbook.Sheets['Clean'];
                            } else {
                                worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            }

                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            processData(jsonData);
                            hideLoading();
                        } catch (err) {
                            console.error('File processing error:', err);
                            alert('Error processing file: ' + err.message);
                            hideLoading();
                        }
                    }, 100);
                };
                reader.onerror = function() {
                    alert('Error reading file');
                    hideLoading();
                };
                reader.readAsArrayBuffer(file);
            });
        }
    });

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function processData(data) {
        console.log(`üìä Processing ${data.length} transactions...`);
        console.log('Sample row:', data[0]);
        console.log('Available columns:', Object.keys(data[0] || {}));

        allData = data.map((row, index) => {
            // Generate stable transaction ID
            const dateStr = row['Transaction date'] || '';
            const vendor = row['Name V2'] || row['Vendor'] || row['Name'] || 'Unknown';
            const amount = calculateAmount(row);
            const transId = generateStableId(dateStr, vendor, amount, index);

            // Determine initial status
            let initialStatus = 'gray';
            if (row['legitimacy']) {
                initialStatus = parseLegitimacy(row['legitimacy']);
            }

            // Override with saved review state
            if (reviewState[transId]?.status) {
                initialStatus = reviewState[transId].status;
            }

            return {
                id: transId,
                date: parseDate(row['Transaction date']),
                vendor: vendor,
                amount: amount,
                type: row['Transaction type'] || 'Unknown',
                description: row['Memo/Description'] || '',
                account: row['Account name'] || 'Unknown',
                category: row['Item class'] || 'Uncategorized',
                legitimacy: row['legitimacy'] || '',
                status: initialStatus,
                riskScore: calculateRiskScore(row, amount)
            };
        });

        console.log(`‚úÖ Successfully loaded ${allData.length} transactions`);
        console.log(`üìÖ Date range: ${allData[0]?.date.toLocaleDateString()} to ${allData[allData.length-1]?.date.toLocaleDateString()}`);
        console.log(`üè¢ Unique vendors: ${new Set(allData.map(t => t.vendor)).size}`);

        groupByVendor();
        updateDashboard();
        runForensicAnalysis();
    }

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function generateStableId(date, vendor, amount, fallbackIndex) {
        const cleanVendor = vendor.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
        const cleanAmount = Math.abs(amount).toFixed(2).replace('.', '');
        const dateObj = parseDate(date);
        const dateStamp = dateObj.getTime();
        return `TXN_${dateStamp}_${cleanVendor}_${cleanAmount}_${fallbackIndex}`;
    }

    function calculateAmount(row) {
        let amount = 0;
        if (row['Debit'] !== undefined && row['Credit'] !== undefined) {
            const debit = parseFloat(row['Debit']) || 0;
            const credit = parseFloat(row['Credit']) || 0;
            amount = debit - credit;
        } else if (row['Amount'] !== undefined) {
            amount = parseFloat(row['Amount']) || 0;
        }
        return amount;
    }

    function parseLegitimacy(legitValue) {
        const legitStr = String(legitValue).toLowerCase();
        if (legitStr.includes('reclass') || legitStr === 'reclass to revenue') {
            return 'reclass';
        } else if (legitStr.includes('green') || legitStr.includes('good') || legitStr.includes('mission')) {
            return 'green';
        } else if (legitStr.includes('red') || legitStr.includes('bad') || legitStr.includes('suspicious')) {
            return 'red';
        } else if (legitStr.includes('yellow') || legitStr.includes('review')) {
            return 'yellow';
        }
        return 'gray';
    }

    function parseDate(dateValue) {
        if (!dateValue) {
            console.warn('Empty date value, using current date');
            return new Date();
        }

        // Excel serial date (number)
        if (typeof dateValue === 'number') {
            // Excel stores dates as days since 1900-01-01
            const excelEpoch = new Date(1900, 0, 1);
            const days = dateValue - 2; // Excel bug: it thinks 1900 was a leap year
            const date = new Date(excelEpoch.getTime() + days * 86400000);
            console.log(`Parsed Excel serial date ${dateValue} -> ${date.toLocaleDateString()}`);
            return date;
        }

        // Already a Date object
        if (dateValue instanceof Date) {
            if (isNaN(dateValue.getTime())) {
                console.warn('Invalid Date object, using current date');
                return new Date();
            }
            return dateValue;
        }

        // String date - try to parse
        if (typeof dateValue === 'string') {
            const parsed = new Date(dateValue);
            if (isNaN(parsed.getTime())) {
                console.warn(`Could not parse date string: "${dateValue}", using current date`);
                return new Date();
            }
            return parsed;
        }

        // Unknown format
        console.warn(`Unknown date format (${typeof dateValue}):`, dateValue, '- using current date');
        return new Date();
    }

    function calculateRiskScore(row, amount) {
        let score = 0;
        const absAmount = Math.abs(amount);
        const date = parseDate(row['Transaction date']);

        // Weekend transaction
        if (date.getDay() === 0 || date.getDay() === 6) score += 2;

        // Round amount
        if (absAmount % 1000 === 0 && absAmount !== 0) score += 1;

        // High amount
        if (absAmount > 10000) score += 3;
        if (absAmount > 50000) score += 5;

        // End of period
        if (date.getDate() >= 28) score += 1;

        // Suspicious vendor patterns
        const vendor = (row['Name V2'] || row['Vendor'] || '').toLowerCase();
        if (vendor.includes('venmo') || vendor.includes('paypal') || vendor.includes('zelle')) {
            score += 3;
        }

        return Math.min(score, 10);
    }

    function groupByVendor() {
        vendorGroups = {};

        allData.forEach(trans => {
            if (!vendorGroups[trans.vendor]) {
                vendorGroups[trans.vendor] = {
                    transactions: [],
                    totalAmount: 0,
                    count: 0,
                    statuses: { green: 0, red: 0, yellow: 0, gray: 0, reclass: 0 },
                    avgRisk: 0
                };
            }

            vendorGroups[trans.vendor].transactions.push(trans);
            vendorGroups[trans.vendor].totalAmount += Math.abs(trans.amount); // Use absolute value for total activity
            vendorGroups[trans.vendor].count++;
            vendorGroups[trans.vendor].statuses[trans.status]++;
        });

        // Calculate average risk per vendor
        Object.keys(vendorGroups).forEach(vendor => {
            const group = vendorGroups[vendor];
            const totalRisk = group.transactions.reduce((sum, t) => sum + t.riskScore, 0);
            group.avgRisk = (totalRisk / group.count).toFixed(1);
        });
    }

    // ============================================================================
    // DASHBOARD UPDATE
    // ============================================================================
    function updateDashboard() {
        updatePopulationStats();
        updateCharts();
        updateVendorTable();
    }

    function updatePopulationStats() {
        const total = allData.length;
        const totalAmt = allData.reduce((sum, t) => sum + t.amount, 0);
        const vendors = Object.keys(vendorGroups).length;
        const highRisk = allData.filter(t => t.riskScore >= 7);
        const reviewed = allData.filter(t => t.status !== 'gray').length;

        // Reclass stats
        const reclassTransactions = allData.filter(t => t.status === 'reclass');
        const reclassCount = reclassTransactions.length;
        const reclassAmt = reclassTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);

        // Date range
        const dates = allData.map(d => d.date);
        const minDate = dates.length > 0 ? new Date(Math.min(...dates)) : new Date();
        const maxDate = dates.length > 0 ? new Date(Math.max(...dates)) : new Date();
        const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));

        // Top vendor
        const topVendor = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount))[0];

        // Update UI - using textContent for security
        document.getElementById('totalTransactions').textContent = total.toLocaleString();
        document.getElementById('transactionPeriod').textContent = 'FY2020 - FY2025';
        document.getElementById('totalAmount').textContent = '$' + totalAmt.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('avgTransaction').textContent = 'Avg: $' + (total > 0 ? (totalAmt / total) : 0).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('uniqueVendors').textContent = vendors.toLocaleString();
        document.getElementById('topVendor').textContent = topVendor ? topVendor[0].substring(0, 30) : 'N/A';
        document.getElementById('dateRange').textContent = minDate.toLocaleDateString() + ' - ' + maxDate.toLocaleDateString();
        document.getElementById('daysCovered').textContent = daysDiff.toLocaleString() + ' days';
        document.getElementById('reviewProgress').textContent = (total > 0 ? ((reviewed / total) * 100).toFixed(1) : 0) + '%';
        document.getElementById('reviewCount').textContent = `${reviewed} of ${total} reviewed`;
        document.getElementById('highRiskCount').textContent = highRisk.length.toLocaleString();
        document.getElementById('riskAmount').textContent = '$' + highRisk.reduce((sum, t) => sum + Math.abs(t.amount), 0).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('reclassCount').textContent = reclassCount.toLocaleString();
        document.getElementById('reclassAmount').textContent = '$' + reclassAmt.toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    // Due to length constraints, I'm truncating here. The rest of the JavaScript would continue with all the remaining functions for charts, vendor tables, modals, PDF management, forensic analysis, etc. - all unchanged from the original code you provided.

    // [Rest of JavaScript code continues - truncated for brevity but would include all remaining functions]

    </script>
</body>
</html>
