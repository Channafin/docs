<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Forensic Analysis Dashboard - Enhanced Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --color-primary: #3498db;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #16a085;
            --color-secondary: #95a5a6;
            --color-dark: #2c3e50;
            --color-light: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--color-dark) 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header .version-badge {
            position: absolute;
            top: 20px;
            right: 30px;
            background: var(--color-success);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
        }

        .shortcuts-help.active {
            display: block;
        }

        .shortcuts-help h3 {
            margin-bottom: 20px;
            color: var(--color-dark);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--color-light);
        }

        .shortcut-key {
            background: var(--color-dark);
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        .population-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--color-primary);
        }

        .stat-card.total { border-left-color: var(--color-dark); }
        .stat-card.amount { border-left-color: var(--color-success); }
        .stat-card.vendors { border-left-color: #8e44ad; }
        .stat-card.period { border-left-color: var(--color-warning); }
        .stat-card.reviewed { border-left-color: var(--color-info); }
        .stat-card.risk { border-left-color: var(--color-danger); }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #7f8c8d;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-dark);
        }

        .stat-subtext {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 3px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-light);
            background: white;
            padding: 10px 20px 0;
            border-radius: 12px 12px 0 0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--color-dark);
            border-bottom-color: var(--color-primary);
        }

        .tab:hover {
            color: #34495e;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 12px 12px;
            margin-top: -20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 450px;
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 15px;
        }

        canvas {
            max-height: 380px !important;
            width: 100% !important;
        }

        /* Vendor Table */
        .vendor-pivot {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .vendor-row {
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }

        .vendor-row:hover {
            background: #e8ecef;
        }

        .vendor-row td {
            padding: 12px;
            border-top: 1px solid #dee2e6;
            font-weight: 600;
        }

        .vendor-row .expand-icon {
            display: inline-block;
            width: 20px;
            transition: transform 0.2s;
        }

        .vendor-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .transaction-row {
            display: none;
            background: white;
        }

        .transaction-row.visible {
            display: table-row;
        }

        .transaction-row.selected {
            background: #e3f2fd;
            border-left: 4px solid var(--color-primary);
        }

        .transaction-row td {
            padding: 10px 12px 10px 40px;
            border-top: 1px solid #f1f3f5;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-green { background: var(--color-success); }
        .status-red { background: var(--color-danger); }
        .status-yellow { background: var(--color-warning); }
        .status-gray { background: var(--color-secondary); }
        .status-reclass { background: #8e44ad; }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-green {
            background: linear-gradient(135deg, var(--color-success) 0%, #229954 100%);
        }

        .btn-red {
            background: linear-gradient(135deg, var(--color-danger) 0%, #c0392b 100%);
        }

        .btn-yellow {
            background: linear-gradient(135deg, var(--color-warning) 0%, #e67e22 100%);
        }

        /* Forensic Alerts */
        .alert-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .alert-item {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item.high {
            background: #fee;
            border-left-color: var(--color-danger);
        }

        .alert-item.medium {
            background: #fff3cd;
            border-left-color: var(--color-warning);
        }

        .alert-item.low {
            background: #d1ecf1;
            border-left-color: var(--color-info);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--color-secondary);
        }

        .close:hover {
            color: var(--color-dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        .form-group textarea,
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        @media print {
            .controls, .tabs, .action-buttons, .shortcuts-help {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div>
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div id="shortcutsHelp" class="shortcuts-help">
        <span class="close" onclick="toggleShortcutsHelp()">&times;</span>
        <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Accept Transaction</span>
            <span class="shortcut-key">A</span>
        </div>
        <div class="shortcut-item">
            <span>Reject Transaction</span>
            <span class="shortcut-key">R</span>
        </div>
        <div class="shortcut-item">
            <span>Review Transaction</span>
            <span class="shortcut-key">Y</span>
        </div>
        <div class="shortcut-item">
            <span>Next Unreviewed</span>
            <span class="shortcut-key">N</span>
        </div>
        <div class="shortcut-item">
            <span>Previous Transaction</span>
            <span class="shortcut-key">P</span>
        </div>
        <div class="shortcut-item">
            <span>Open Detail Modal</span>
            <span class="shortcut-key">Space</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Help</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>

    <div class="header">
        <h1>CPA Forensic Analysis Dashboard - Enhanced Edition</h1>
        <p class="subtitle">Advanced Transaction Review System | Tampa Bay Trial Lawyers Association</p>
        <div class="version-badge">v7.0 Enhanced</div>
    </div>

    <div class="container">
        <!-- Population Statistics -->
        <div class="population-stats">
            <h2 style="margin-bottom: 20px; color: var(--color-dark);">Complete Transaction Population Overview</h2>
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-value" id="totalTransactions">-</div>
                    <div class="stat-subtext" id="transactionPeriod">Loading...</div>
                </div>
                <div class="stat-card amount">
                    <div class="stat-label">Total Amount</div>
                    <div class="stat-value" id="totalAmount">-</div>
                    <div class="stat-subtext" id="avgTransaction">Avg: -</div>
                </div>
                <div class="stat-card vendors">
                    <div class="stat-label">Unique Vendors</div>
                    <div class="stat-value" id="uniqueVendors">-</div>
                    <div class="stat-subtext" id="topVendor">Top: -</div>
                </div>
                <div class="stat-card period">
                    <div class="stat-label">Date Range</div>
                    <div class="stat-value" id="dateRange" style="font-size: 16px;">-</div>
                    <div class="stat-subtext" id="daysCovered">- days</div>
                </div>
                <div class="stat-card reviewed">
                    <div class="stat-label">Review Progress</div>
                    <div class="stat-value" id="reviewProgress">0%</div>
                    <div class="stat-subtext" id="reviewCount">0 of 0 reviewed</div>
                </div>
                <div class="stat-card risk">
                    <div class="stat-label">High Risk Items</div>
                    <div class="stat-value" id="highRiskCount">0</div>
                    <div class="stat-subtext" id="riskAmount">$0.00</div>
                </div>
                <div class="stat-card" style="border-left-color: #8e44ad;">
                    <div class="stat-label">Reclass to Revenue</div>
                    <div class="stat-value" id="reclassCount">0</div>
                    <div class="stat-subtext" id="reclassAmount">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview & Analysis</button>
            <button class="tab" onclick="switchTab('review')">‚úÖ Transaction Review</button>
            <button class="tab" onclick="switchTab('forensics')">üîç Forensic Insights</button>
            <button class="tab" onclick="switchTab('documents')">üìé Document Management</button>
            <button class="tab" onclick="switchTab('reports')">üìã Reports & Export</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>Upload Transaction File</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" value="2020-01-01">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" value="2025-12-31">
                </div>
                <button onclick="updateDashboard()">üîÑ Refresh Analysis</button>
                <button onclick="toggleShortcutsHelp()">‚å®Ô∏è Keyboard Shortcuts</button>
                <button onclick="showStatusByYearOverlay()" style="background: #9b59b6; color: white;">üìä Status by Year</button>
            </div>

            <!-- Chart Filters -->
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <strong style="color: #34495e;">Filter Charts:</strong>
                    <button id="chartFilterAll" onclick="filterCharts('all')" style="background: #3498db; color: white; font-weight: bold;">All</button>
                    <button id="chartFilterGreen" onclick="filterCharts('green')" style="background: #d4edda; color: #155724;">‚úÖ Green (Mission)</button>
                    <button id="chartFilterRed" onclick="filterCharts('red')" style="background: #f8d7da; color: #721c24;">‚ùå Red (Non-mission)</button>
                    <button id="chartFilterYellow" onclick="filterCharts('yellow')" style="background: #fff3cd; color: #856404;">‚ö†Ô∏è Yellow (Review)</button>
                    <button id="chartFilterReclass" onclick="filterCharts('reclass')" style="background: #e8daef; color: #4a235a;">üîÑ Reclass</button>
                    <span style="margin-left: 20px; color: #95a5a6;">|</span>
                    <strong style="color: #34495e;">Type:</strong>
                    <button id="typeFilterAll" onclick="filterByType('all')" style="background: #3498db; color: white; font-weight: bold;">All</button>
                    <button id="typeFilterCC" onclick="filterByType('Credit Card')">üí≥ Credit Card</button>
                    <button id="typeFilterBank" onclick="filterByType('Bank')">üè¶ Bank</button>
                    <span style="margin-left: 20px; color: #95a5a6;">|</span>
                    <strong style="color: #34495e;">View:</strong>
                    <button id="viewQuarterly" onclick="setChartView('quarterly')" style="background: #3498db; color: white; font-weight: bold;">üìÖ Quarterly</button>
                    <button id="viewAnnual" onclick="setChartView('annual')">üìä Annual</button>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Review Status Distribution</div>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Transaction Volume</div>
                    <canvas id="volumeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 10 Vendors by Amount</div>
                    <canvas id="vendorChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üö® Top High-Risk Vendors</div>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Review Tab -->
        <div id="review-tab" class="tab-content">
            <div class="controls">
                <input type="text" id="vendorSearch" placeholder="üîç Search vendors..." style="flex: 1;">
                <button onclick="selectAllVisible()">‚òëÔ∏è Select All</button>
                <button onclick="batchAccept()">‚úÖ Batch Accept</button>
                <button onclick="batchReject()">‚ùå Batch Reject</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="vendor-pivot" id="vendorTable">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 12px; text-align: left;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th style="padding: 12px; text-align: left;">Vendor / Transaction</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">Category</th>
                            <th style="padding: 12px; text-align: center;">üìé Docs</th>
                            <th style="padding: 12px;">Risk</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorTableBody">
                        <tr><td colspan="8" style="text-align: center; padding: 40px; background: #f8f9fa;">
                            <div style="font-size: 18px; margin-bottom: 10px;">üìÅ Load Your Transaction Data</div>
                            <div>Use the <strong>Upload File</strong> button above</div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Forensic Insights Tab -->
        <div id="forensics-tab" class="tab-content">
            <div class="alert-panel">
                <h3 style="margin-bottom: 15px;">üö® Real-time Forensic Alerts</h3>
                <div id="forensicAlerts">
                    <p style="color: #7f8c8d;">Load transaction data to see forensic analysis</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Benford's Law Analysis</div>
                    <canvas id="benfordChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Payment Velocity (Transactions per Vendor)</div>
                    <canvas id="velocityChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Statistical Outliers</div>
                    <canvas id="outlierChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Duplicate Detection</div>
                    <div id="duplicateList" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Document Management Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìé Bulk PDF Upload & Matching</h3>
                <input type="file" id="bulkPdfUpload" multiple accept=".pdf" style="display: none;">
                <button onclick="document.getElementById('bulkPdfUpload').click()" style="margin: 10px 0;">üìÅ Select PDFs to Upload</button>
                <div id="pdfUploadStatus" style="margin-top: 10px;"></div>
            </div>

            <div class="alert-panel">
                <h3>üìä Document Status Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: #d4edda; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMatched">0</div>
                        <div>Matched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsUnmatched">0</div>
                        <div>Unmatched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMissing">0</div>
                        <div>Missing Documentation</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìã Generate Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <button onclick="exportAuditReport()">üìä Complete Audit Report</button>
                    <button onclick="exportManagementLetter()">üìù Management Letter</button>
                    <button onclick="exportExceptionReport()">üö® Exception Report Only</button>
                    <button onclick="exportComplianceReport()">‚úÖ Compliance Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Transaction Review</h2>
            <div id="modalTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

            <div class="form-group">
                <label>Review Decision</label>
                <select id="reviewDecision">
                    <option value="">-- Select Status --</option>
                    <option value="green">‚úÖ Green - Mission Related</option>
                    <option value="red">‚ùå Red - Non-mission/Suspicious</option>
                    <option value="yellow">‚ö†Ô∏è Yellow - Needs Further Review</option>
                    <option value="reclass">üîÑ Reclass to Revenue</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Category</label>
                <select id="reviewCategory">
                    <option value="">-- Select Category --</option>
                    <option value="verified">Verified with Documentation</option>
                    <option value="mission">Mission/Program Related</option>
                    <option value="authorized">Properly Authorized</option>
                    <option value="suspicious">Suspicious - Investigate</option>
                    <option value="duplicate">Duplicate Transaction</option>
                    <option value="personal">Personal/Non-Business</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Notes (Max 5000 characters)</label>
                <textarea id="reviewNotes" maxlength="5000" placeholder="Enter detailed review notes..."></textarea>
                <div style="text-align: right; font-size: 12px; color: #7f8c8d;">
                    <span id="charCount">0</span>/5000
                </div>
            </div>

            <div class="form-group">
                <label>üìé Supporting Documentation</label>
                <div id="modalAttachmentList" style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 40px;">
                    <em style="color: #95a5a6;">No documents attached</em>
                </div>
                <input type="file" id="modalPdfUpload" accept=".pdf" multiple style="display: none;">
                <button type="button" onclick="document.getElementById('modalPdfUpload').click()" style="background: var(--color-info); width: 100%;">
                    üìÅ Upload PDF Documents
                </button>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeModal()" style="background: var(--color-secondary);">Cancel</button>
                <button onclick="saveReview()">üíæ Save Review</button>
            </div>
        </div>
    </div>

    <!-- Journal Entry Generator Modal -->
    <div id="jeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJEModal()">&times;</span>
            <h2>üìù Generate Journal Entry</h2>

            <div id="jeTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

            <div class="form-group">
                <label>Journal Entry Type</label>
                <select id="jeType" onchange="updateJETemplate()">
                    <option value="reclass">Reclassification</option>
                    <option value="correction">Correction</option>
                    <option value="reversal">Reversal</option>
                    <option value="accrual">Accrual</option>
                </select>
            </div>

            <div class="form-group">
                <label>Debit Account</label>
                <input type="text" id="jeDebitAccount" placeholder="e.g., Program Expenses - Education">
            </div>

            <div class="form-group">
                <label>Credit Account</label>
                <input type="text" id="jeCreditAccount" placeholder="e.g., Office Supplies">
            </div>

            <div class="form-group">
                <label>Memo/Description</label>
                <textarea id="jeMemo" rows="2" placeholder="Auto-filled from transaction"></textarea>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h3 style="margin-bottom: 10px; font-size: 14px; color: var(--color-dark);">Preview</h3>
                <pre id="jePreview" style="font-family: 'Courier New', monospace; font-size: 13px; white-space: pre; overflow-x: auto;"></pre>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <div>
                    <button onclick="copyJEToClipboard()" style="background: var(--color-info);">üìã Copy to Clipboard</button>
                    <button onclick="downloadJEAsCSV()" style="background: var(--color-success);">üì• Download CSV</button>
                </div>
                <button onclick="closeJEModal()" style="background: var(--color-secondary);">Close</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <span class="close" onclick="closePdfPreview()">&times;</span>
            <h2 id="pdfPreviewTitle">üìÑ Document Preview</h2>
            <div id="pdfPreviewInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 13px;"></div>
            <div style="height: 600px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; background: #f5f5f5;">
                <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button onclick="downloadCurrentPdf()" style="background: var(--color-success);">üì• Download</button>
                <button onclick="closePdfPreview()" style="background: var(--color-secondary);">Close</button>
            </div>
        </div>
    </div>

    <!-- Status by Year Overlay Modal -->
    <div id="statusByYearModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <span class="close" onclick="closeStatusByYearOverlay()">&times;</span>
            <h2>üìä Transaction Status Distribution by Year</h2>
            <p style="color: #7f8c8d; margin: 10px 0;">Shows all transaction data grouped by year and status</p>
            <div style="height: 500px; margin: 20px 0;">
                <canvas id="statusByYearChart"></canvas>
            </div>
            <button onclick="closeStatusByYearOverlay()" style="background: var(--color-secondary);">Close</button>
        </div>
    </div>

    <script>
    // ============================================================================
    // GLOBAL ERROR HANDLER
    // ============================================================================
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error:', msg, error);
        alert('An error occurred. Please save your work and refresh if needed.');
        return false;
    };

    // ============================================================================
    // SECURITY: HTML ESCAPE FUNCTION
    // ============================================================================
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ============================================================================
    // SAFE LOCALSTORAGE OPERATIONS
    // ============================================================================
    function safeLocalStorageSet(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('localStorage save failed:', e);
            if (e.name === 'QuotaExceededError') {
                alert('Storage is full. Please export your data and clear old reviews.');
            } else {
                alert('Unable to save data. Storage may be disabled.');
            }
            return false;
        }
    }

    function safeLocalStorageGet(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('localStorage read failed:', e);
            return defaultValue;
        }
    }

    // ============================================================================
    // LOADING SPINNER
    // ============================================================================
    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        overlay.classList.add('active');
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('active');
    }

    // ============================================================================
    // KEYBOARD SHORTCUTS
    // ============================================================================
    function toggleShortcutsHelp() {
        const help = document.getElementById('shortcutsHelp');
        help.classList.toggle('active');
    }

    document.addEventListener('keydown', function(e) {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }

        const key = e.key.toLowerCase();

        if (key === '?') {
            toggleShortcutsHelp();
        } else if (key === 'a' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'green', e);
        } else if (key === 'r' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'red', e);
        } else if (key === 'y' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'yellow', e);
        } else if (key === 'n') {
            navigateToNext(true);
        } else if (key === 'p') {
            navigateToPrevious();
        } else if (key === ' ' && currentSelectedTransaction) {
            e.preventDefault();
            openReviewModal(currentSelectedTransaction, e);
        }
    });

    // ============================================================================
    // GLOBAL VARIABLES
    // ============================================================================
    let allData = [];
    let vendorGroups = {};
    let reviewState = {};
    let charts = {};
    let currentTransactionId = null;
    let currentSelectedTransaction = null;
    let pdfAttachments = {};
    let chartView = 'quarterly';
    let currentChartFilter = 'all';
    let currentTypeFilter = 'all';
    let periodVendorData = {};

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    window.onload = function() {
        reviewState = safeLocalStorageGet('cpaForensicReviewState', {});
        pdfAttachments = safeLocalStorageGet('pdfAttachments', {});

        // Set up PDF upload handler
        const bulkUpload = document.getElementById('bulkPdfUpload');
        if (bulkUpload) {
            bulkUpload.addEventListener('change', handleBulkPdfUpload);
        }

        // Set up modal PDF upload handler
        const modalUpload = document.getElementById('modalPdfUpload');
        if (modalUpload) {
            modalUpload.addEventListener('change', handleModalPdfUpload);
        }

        // Character counter for notes
        const notesField = document.getElementById('reviewNotes');
        if (notesField) {
            notesField.addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
        }

        // Register Chart.js plugin properly
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            Chart.defaults.plugins.datalabels.display = false;
        }
    };

    // ============================================================================
    // FILE UPLOAD HANDLER
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                showLoading('Reading Excel file...');

                const reader = new FileReader();
                reader.onload = function(e) {
                    setTimeout(() => {
                        try {
                            showLoading('Processing transactions...');
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});

                            let worksheet;
                            if (workbook.Sheets['Clean']) {
                                worksheet = workbook.Sheets['Clean'];
                            } else {
                                worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            }

                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            processData(jsonData);
                            hideLoading();
                        } catch (err) {
                            console.error('File processing error:', err);
                            alert('Error processing file: ' + err.message);
                            hideLoading();
                        }
                    }, 100);
                };
                reader.onerror = function() {
                    alert('Error reading file');
                    hideLoading();
                };
                reader.readAsArrayBuffer(file);
            });
        }
    });

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function processData(data) {
        console.log(`üìä Processing ${data.length} transactions...`);
        console.log('Sample row:', data[0]);
        console.log('Available columns:', Object.keys(data[0] || {}));

        allData = data.map((row, index) => {
            // Generate stable transaction ID
            const dateStr = row['Transaction date'] || '';
            const vendor = row['Name V2'] || row['Vendor'] || row['Name'] || 'Unknown';
            const amount = calculateAmount(row);
            const transId = generateStableId(dateStr, vendor, amount, index);

            // Determine initial status
            let initialStatus = 'gray';
            if (row['legitimacy']) {
                initialStatus = parseLegitimacy(row['legitimacy']);
            }

            // Override with saved review state
            if (reviewState[transId]?.status) {
                initialStatus = reviewState[transId].status;
            }

            return {
                id: transId,
                date: parseDate(row['Transaction date']),
                vendor: vendor,
                amount: amount,
                type: row['Transaction type'] || 'Unknown',
                description: row['Memo/Description'] || '',
                account: row['Account name'] || 'Unknown',
                category: row['Item class'] || 'Uncategorized',
                legitimacy: row['legitimacy'] || '',
                status: initialStatus,
                riskScore: calculateRiskScore(row, amount)
            };
        });

        console.log(`‚úÖ Successfully loaded ${allData.length} transactions`);
        console.log(`üìÖ Date range: ${allData[0]?.date.toLocaleDateString()} to ${allData[allData.length-1]?.date.toLocaleDateString()}`);
        console.log(`üè¢ Unique vendors: ${new Set(allData.map(t => t.vendor)).size}`);

        groupByVendor();
        updateDashboard();
        runForensicAnalysis();
    }

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function generateStableId(date, vendor, amount, fallbackIndex) {
        const cleanVendor = vendor.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
        const cleanAmount = Math.abs(amount).toFixed(2).replace('.', '');
        const dateObj = parseDate(date);
        const dateStamp = dateObj.getTime();
        return `TXN_${dateStamp}_${cleanVendor}_${cleanAmount}_${fallbackIndex}`;
    }

    function calculateAmount(row) {
        let amount = 0;
        if (row['Debit'] !== undefined && row['Credit'] !== undefined) {
            const debit = parseFloat(row['Debit']) || 0;
            const credit = parseFloat(row['Credit']) || 0;
            amount = debit - credit;
        } else if (row['Amount'] !== undefined) {
            amount = parseFloat(row['Amount']) || 0;
        }
        return amount;
    }

    function parseLegitimacy(legitValue) {
        const legitStr = String(legitValue).toLowerCase();
        if (legitStr.includes('reclass') || legitStr === 'reclass to revenue') {
            return 'reclass';
        } else if (legitStr.includes('green') || legitStr.includes('good') || legitStr.includes('mission')) {
            return 'green';
        } else if (legitStr.includes('red') || legitStr.includes('bad') || legitStr.includes('suspicious')) {
            return 'red';
        } else if (legitStr.includes('yellow') || legitStr.includes('review')) {
            return 'yellow';
        }
        return 'gray';
    }

    function parseDate(dateValue) {
        if (!dateValue) {
            console.warn('Empty date value, using current date');
            return new Date();
        }

        // Excel serial date (number)
        if (typeof dateValue === 'number') {
            // Excel stores dates as days since 1900-01-01
            const excelEpoch = new Date(1900, 0, 1);
            const days = dateValue - 2; // Excel bug: it thinks 1900 was a leap year
            const date = new Date(excelEpoch.getTime() + days * 86400000);
            console.log(`Parsed Excel serial date ${dateValue} -> ${date.toLocaleDateString()}`);
            return date;
        }

        // Already a Date object
        if (dateValue instanceof Date) {
            if (isNaN(dateValue.getTime())) {
                console.warn('Invalid Date object, using current date');
                return new Date();
            }
            return dateValue;
        }

        // String date - try to parse
        if (typeof dateValue === 'string') {
            const parsed = new Date(dateValue);
            if (isNaN(parsed.getTime())) {
                console.warn(`Could not parse date string: "${dateValue}", using current date`);
                return new Date();
            }
            return parsed;
        }

        // Unknown format
        console.warn(`Unknown date format (${typeof dateValue}):`, dateValue, '- using current date');
        return new Date();
    }

    function calculateRiskScore(row, amount) {
        let score = 0;
        const absAmount = Math.abs(amount);
        const date = parseDate(row['Transaction date']);

        // Weekend transaction
        if (date.getDay() === 0 || date.getDay() === 6) score += 2;

        // Round amount
        if (absAmount % 1000 === 0 && absAmount !== 0) score += 1;

        // High amount
        if (absAmount > 10000) score += 3;
        if (absAmount > 50000) score += 5;

        // End of period
        if (date.getDate() >= 28) score += 1;

        // Suspicious vendor patterns
        const vendor = (row['Name V2'] || row['Vendor'] || '').toLowerCase();
        if (vendor.includes('venmo') || vendor.includes('paypal') || vendor.includes('zelle')) {
            score += 3;
        }

        return Math.min(score, 10);
    }

    function groupByVendor() {
        vendorGroups = {};

        allData.forEach(trans => {
            if (!vendorGroups[trans.vendor]) {
                vendorGroups[trans.vendor] = {
                    transactions: [],
                    totalAmount: 0,
                    count: 0,
                    statuses: { green: 0, red: 0, yellow: 0, gray: 0, reclass: 0 },
                    avgRisk: 0
                };
            }

            vendorGroups[trans.vendor].transactions.push(trans);
            vendorGroups[trans.vendor].totalAmount += trans.amount;
            vendorGroups[trans.vendor].count++;
            vendorGroups[trans.vendor].statuses[trans.status]++;
        });

        // Calculate average risk per vendor
        Object.keys(vendorGroups).forEach(vendor => {
            const group = vendorGroups[vendor];
            const totalRisk = group.transactions.reduce((sum, t) => sum + t.riskScore, 0);
            group.avgRisk = (totalRisk / group.count).toFixed(1);
        });
    }

    // ============================================================================
    // DASHBOARD UPDATE
    // ============================================================================
    function updateDashboard() {
        updatePopulationStats();
        updateCharts();
        updateVendorTable();
    }

    function updatePopulationStats() {
        const total = allData.length;
        const totalAmt = allData.reduce((sum, t) => sum + t.amount, 0);
        const vendors = Object.keys(vendorGroups).length;
        const highRisk = allData.filter(t => t.riskScore >= 7);
        const reviewed = allData.filter(t => t.status !== 'gray').length;

        // Reclass stats
        const reclassTransactions = allData.filter(t => t.status === 'reclass');
        const reclassCount = reclassTransactions.length;
        const reclassAmt = reclassTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);

        // Date range
        const dates = allData.map(d => d.date);
        const minDate = dates.length > 0 ? new Date(Math.min(...dates)) : new Date();
        const maxDate = dates.length > 0 ? new Date(Math.max(...dates)) : new Date();
        const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));

        // Top vendor
        const topVendor = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount))[0];

        // Update UI - using textContent for security
        document.getElementById('totalTransactions').textContent = total.toLocaleString();
        document.getElementById('transactionPeriod').textContent = 'FY2020 - FY2025';
        document.getElementById('totalAmount').textContent = '$' + totalAmt.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('avgTransaction').textContent = 'Avg: $' + (total > 0 ? (totalAmt / total) : 0).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('uniqueVendors').textContent = vendors.toLocaleString();
        document.getElementById('topVendor').textContent = topVendor ? topVendor[0].substring(0, 30) : 'N/A';
        document.getElementById('dateRange').textContent = minDate.toLocaleDateString() + ' - ' + maxDate.toLocaleDateString();
        document.getElementById('daysCovered').textContent = daysDiff.toLocaleString() + ' days';
        document.getElementById('reviewProgress').textContent = (total > 0 ? ((reviewed / total) * 100).toFixed(1) : 0) + '%';
        document.getElementById('reviewCount').textContent = `${reviewed} of ${total} reviewed`;
        document.getElementById('highRiskCount').textContent = highRisk.length.toLocaleString();
        document.getElementById('riskAmount').textContent = '$' + highRisk.reduce((sum, t) => sum + Math.abs(t.amount), 0).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('reclassCount').textContent = reclassCount.toLocaleString();
        document.getElementById('reclassAmount').textContent = '$' + reclassAmt.toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    // ============================================================================
    // CHARTS
    // ============================================================================
    function updateCharts() {
        // Destroy existing charts
        Object.values(charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        charts = {};

        // Filter data based on current filters
        let filteredData = allData;
        if (currentChartFilter !== 'all') {
            filteredData = allData.filter(t => t.status === currentChartFilter);
        }
        if (currentTypeFilter !== 'all') {
            filteredData = filteredData.filter(t => {
                const typeLower = (t.type || '').toLowerCase();
                const filterLower = currentTypeFilter.toLowerCase();
                return typeLower.includes(filterLower) || typeLower.includes(filterLower.replace(' ', ''));
            });
        }

        // Status chart
        const statusCounts = {
            'Mission Related': filteredData.filter(t => t.status === 'green').length,
            'Non-mission': filteredData.filter(t => t.status === 'red').length,
            'Needs Review': filteredData.filter(t => t.status === 'yellow').length,
            'Reclass to Revenue': filteredData.filter(t => t.status === 'reclass').length,
            'Unreviewed': filteredData.filter(t => t.status === 'gray').length
        };

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            const totalCount = Object.values(statusCounts).reduce((a, b) => a + b, 0);
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12', '#8e44ad', '#95a5a6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: (value, context) => {
                                if (value === 0) return '';
                                const percentage = totalCount > 0 ? ((value / totalCount) * 100).toFixed(1) : 0;
                                return `${value}\n(${percentage}%)`;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Volume chart with vendor tracking
        const monthlyData = {};
        periodVendorData = {};
        filteredData.forEach(t => {
            let key;
            if (chartView === 'annual') {
                key = `${t.date.getFullYear()}`;
            } else {
                // Quarterly view
                const year = t.date.getFullYear();
                const month = t.date.getMonth();
                const quarter = Math.floor(month / 3) + 1;
                key = `${year}-Q${quarter}`;
            }

            monthlyData[key] = (monthlyData[key] || 0) + t.amount;

            // Track vendors per period
            if (!periodVendorData[key]) {
                periodVendorData[key] = {};
            }
            periodVendorData[key][t.vendor] = (periodVendorData[key][t.vendor] || 0) + t.amount;
        });

        const sortedMonths = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));

        const volumeCtx = document.getElementById('volumeChart');
        if (volumeCtx) {
            charts.volume = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(([k]) => k),
                    datasets: [{
                        label: chartView === 'annual' ? 'Annual Volume' : 'Quarterly Volume',
                        data: sortedMonths.map(([, v]) => v),
                        backgroundColor: currentChartFilter === 'green' ? '#27ae60' :
                                        currentChartFilter === 'red' ? '#e74c3c' :
                                        currentChartFilter === 'yellow' ? '#f39c12' :
                                        currentChartFilter === 'reclass' ? '#8e44ad' : '#3498db',
                        borderColor: currentChartFilter === 'green' ? '#229954' :
                                   currentChartFilter === 'red' ? '#c0392b' :
                                   currentChartFilter === 'yellow' ? '#d68910' :
                                   currentChartFilter === 'reclass' ? '#6c3483' : '#2874a6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const period = context.label;
                                    const vendors = periodVendorData[period];
                                    if (!vendors) return [];

                                    const sortedVendors = Object.entries(vendors)
                                        .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
                                        .slice(0, 5); // Top 5 vendors

                                    const lines = ['', 'Top Vendors:'];
                                    sortedVendors.forEach(([vendor, amount]) => {
                                        lines.push(`  ${vendor.substring(0, 20)}: $${Math.abs(amount).toLocaleString()}`);
                                    });

                                    if (Object.keys(vendors).length > 5) {
                                        lines.push(`  ... and ${Object.keys(vendors).length - 5} more`);
                                    }

                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Top vendors - filtered
        const filteredVendorGroups = {};
        filteredData.forEach(trans => {
            if (!filteredVendorGroups[trans.vendor]) {
                filteredVendorGroups[trans.vendor] = 0;
            }
            filteredVendorGroups[trans.vendor] += trans.amount;
        });

        const topVendors = Object.entries(filteredVendorGroups)
            .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
            .slice(0, 10);

        const vendorCtx = document.getElementById('vendorChart');
        if (vendorCtx) {
            charts.vendor = new Chart(vendorCtx, {
                type: 'bar',
                data: {
                    labels: topVendors.map(([name]) => name.substring(0, 30)),
                    datasets: [{
                        label: 'Total Amount',
                        data: topVendors.map(([, amount]) => amount),
                        backgroundColor: currentChartFilter === 'green' ? '#27ae60' :
                                        currentChartFilter === 'red' ? '#e74c3c' :
                                        currentChartFilter === 'yellow' ? '#f39c12' :
                                        currentChartFilter === 'reclass' ? '#8e44ad' : '#7f3d9b'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        }
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            backgroundColor: function(context) {
                                return currentChartFilter === 'green' ? '#27ae60' :
                                       currentChartFilter === 'red' ? '#c0392b' :
                                       currentChartFilter === 'yellow' ? '#f39c12' :
                                       currentChartFilter === 'reclass' ? '#7f3d9b' : '#7f3d9b';
                            },
                            borderRadius: 3,
                            padding: 4,
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => {
                                const absValue = Math.abs(value);
                                if (absValue >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (absValue >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Top High-Risk Vendors
        const vendorRiskData = Object.entries(vendorGroups)
            .map(([vendor, data]) => ({
                vendor: vendor,
                avgRisk: parseFloat(data.avgRisk),
                count: data.count,
                totalAmount: data.totalAmount
            }))
            .sort((a, b) => b.avgRisk - a.avgRisk)
            .slice(0, 10);

        const riskCtx = document.getElementById('riskChart');
        if (riskCtx) {
            charts.risk = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: vendorRiskData.map(v => v.vendor.substring(0, 25)),
                    datasets: [{
                        label: 'Average Risk Score',
                        data: vendorRiskData.map(v => v.avgRisk),
                        backgroundColor: vendorRiskData.map(v =>
                            v.avgRisk >= 7 ? '#e74c3c' :
                            v.avgRisk >= 4 ? '#f39c12' : '#27ae60'
                        )
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Risk Score (0-10)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const vendor = vendorRiskData[context.dataIndex];
                                    return [
                                        `Transactions: ${vendor.count}`,
                                        `Total Amount: $${Math.abs(vendor.totalAmount).toLocaleString('en-US', {minimumFractionDigits: 2})}`
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            backgroundColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 7 ? '#c0392b' : value >= 4 ? '#e67e22' : '#27ae60';
                            },
                            borderRadius: 3,
                            padding: 4,
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, context) => {
                                const vendor = vendorRiskData[context.dataIndex];
                                return `${value.toFixed(1)} (${vendor.count} txns)`;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    }

    // ============================================================================
    // VENDOR TABLE
    // ============================================================================
    function updateVendorTable() {
        const tbody = document.getElementById('vendorTableBody');
        if (!tbody) return;

        let html = '';
        const sortedVendors = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount));

        sortedVendors.forEach(([vendorName, vendorData]) => {
            const vendorId = 'vendor_' + vendorName.replace(/[^a-zA-Z0-9]/g, '_');
            const escapedVendor = escapeHtml(vendorName);

            // Vendor status (priority: red > reclass > yellow > green > gray)
            let vendorStatus = 'gray';
            if (vendorData.statuses.red > 0) vendorStatus = 'red';
            else if (vendorData.statuses.reclass > 0) vendorStatus = 'reclass';
            else if (vendorData.statuses.yellow > 0) vendorStatus = 'yellow';
            else if (vendorData.statuses.green > 0) vendorStatus = 'green';

            // Count docs for this vendor
            const docsCount = vendorData.transactions.reduce((sum, t) => {
                return sum + (pdfAttachments[t.id] ? pdfAttachments[t.id].length : 0);
            }, 0);

            html += `
                <tr class="vendor-row" onclick="toggleVendor('${vendorId}')" onkeydown="if(event.key==='Enter'||event.key===' ')toggleVendor('${vendorId}')" tabindex="0" role="button" aria-expanded="false" data-vendor="${vendorId}">
                    <td><input type="checkbox" class="vendor-checkbox" data-vendor-id="${vendorId}" onchange="toggleVendorCheckboxes('${vendorId}')" onclick="event.stopPropagation()"></td>
                    <td>
                        <span class="expand-icon">‚ñ∂</span>
                        <strong>${escapedVendor}</strong>
                        <span style="color: #95a5a6; font-size: 12px; margin-left: 10px;">
                            (${vendorData.count} transactions)
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 600;">
                        $${vendorData.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                    </td>
                    <td style="text-align: center;">
                        <span class="status-indicator status-${vendorStatus}"></span>
                    </td>
                    <td style="text-align: center;">
                        <span style="font-size: 11px; color: #7f8c8d;">-</span>
                    </td>
                    <td style="text-align: center;">
                        ${docsCount > 0 ? 'üìé ' + docsCount : '-'}
                    </td>
                    <td style="text-align: center;">
                        <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background: ${
                            vendorData.avgRisk >= 7 ? '#fee' : vendorData.avgRisk >= 4 ? '#fff3cd' : '#d4edda'
                        }; color: ${
                            vendorData.avgRisk >= 7 ? '#c0392b' : vendorData.avgRisk >= 4 ? '#856404' : '#155724'
                        };">${vendorData.avgRisk}</span>
                    </td>
                    <td></td>
                </tr>
            `;

            // Transaction rows
            vendorData.transactions.forEach(trans => {
                const review = reviewState[trans.id] || {};
                const escapedDesc = escapeHtml(trans.description.substring(0, 50));
                const escapedNotes = review.notes ? escapeHtml(review.notes.substring(0, 100)) : '';

                // Format category display
                const categoryLabel = {
                    'verified': '‚úì Verified',
                    'mission': 'üéØ Mission',
                    'authorized': '‚úÖ Authorized',
                    'suspicious': '‚ö†Ô∏è Suspicious',
                    'duplicate': 'üìã Duplicate',
                    'personal': 'üë§ Personal'
                };
                const categoryDisplay = review.category ? (categoryLabel[review.category] || review.category) : '-';

                // Format docs with confidence
                let docsDisplay = '<span style="color: #bdc3c7;">-</span>';
                if (pdfAttachments[trans.id] && pdfAttachments[trans.id].length > 0) {
                    const attachments = pdfAttachments[trans.id];
                    const highestScore = Math.max(...attachments.map(a => a.matchScore || 0));
                    const confidenceColor = highestScore >= 80 ? '#27ae60' : highestScore >= 50 ? '#f39c12' : '#e74c3c';
                    const confidenceText = highestScore >= 80 ? 'High' : highestScore >= 50 ? 'Med' : 'Low';
                    docsDisplay = `<span style="color: #3498db; cursor: pointer;" onclick="event.stopPropagation(); previewAttachment('${trans.id}', 0)">üìé${attachments.length}</span>
                                   <br><span style="font-size: 10px; color: ${confidenceColor}; font-weight: bold;">${confidenceText} ${highestScore}%</span>`;
                }

                html += `
                    <tr class="transaction-row" data-vendor="${vendorId}" data-trans-id="${trans.id}" data-status="${trans.status}">
                        <td><input type="checkbox" class="trans-checkbox" data-trans-id="${trans.id}" onclick="event.stopPropagation(); selectTransaction('${trans.id}')"></td>
                        <td>${trans.date.toLocaleDateString()} - ${escapedDesc}</td>
                        <td style="text-align: right;">
                            $${Math.abs(trans.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </td>
                        <td style="text-align: center;">
                            <span class="status-indicator status-${trans.status}"></span>
                            ${trans.status === 'green' ? 'Green' : trans.status === 'red' ? 'Red' : trans.status === 'yellow' ? 'Yellow' : trans.status === 'reclass' ? 'Reclass' : 'Unreviewed'}
                        </td>
                        <td style="text-align: center; font-size: 11px; color: #5a6c7d;">
                            ${categoryDisplay}
                        </td>
                        <td style="text-align: center;">
                            ${docsDisplay}
                        </td>
                        <td style="text-align: center;">
                            <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; background: ${
                                trans.riskScore >= 7 ? '#fee' : trans.riskScore >= 4 ? '#fff3cd' : '#d4edda'
                            };">${trans.riskScore}</span>
                        </td>
                        <td style="text-align: center;">
                            <div class="action-buttons">
                                <button class="btn-small btn-green" onclick="quickStatus('${trans.id}', 'green', event)">‚úÖ</button>
                                <button class="btn-small btn-red" onclick="quickStatus('${trans.id}', 'red', event)">‚ùå</button>
                                <button class="btn-small btn-yellow" onclick="quickStatus('${trans.id}', 'yellow', event)">‚ö†Ô∏è</button>
                                <button class="btn-small" onclick="openReviewModal('${trans.id}', event)">üìù</button>
                                <button class="btn-small" onclick="openJEModal('${trans.id}', event)" style="background: var(--color-info);" title="Generate Journal Entry">üßæ</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        });

        tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 40px;">No data loaded</td></tr>';
    }

    // ============================================================================
    // VENDOR INTERACTION
    // ============================================================================
    function toggleVendor(vendorId) {
        const vendorRow = document.querySelector(`.vendor-row[data-vendor="${vendorId}"]`);
        const transRows = document.querySelectorAll(`.transaction-row[data-vendor="${vendorId}"]`);

        vendorRow.classList.toggle('expanded');
        transRows.forEach(row => row.classList.toggle('visible'));

        const isExpanded = vendorRow.classList.contains('expanded');
        vendorRow.setAttribute('aria-expanded', isExpanded);
    }

    function selectTransaction(transId) {
        currentSelectedTransaction = transId;
        document.querySelectorAll('.transaction-row').forEach(row => {
            row.classList.remove('selected');
        });
        const row = document.querySelector(`.transaction-row[data-trans-id="${transId}"]`);
        if (row) row.classList.add('selected');
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAllCheckbox').checked;
        document.querySelectorAll('.trans-checkbox').forEach(cb => cb.checked = checked);
    }

    function selectAllVisible() {
        document.querySelectorAll('.transaction-row.visible .trans-checkbox').forEach(cb => cb.checked = true);
    }

    function toggleVendorCheckboxes(vendorId) {
        const vendorCheckbox = document.querySelector(`.vendor-checkbox[data-vendor-id="${vendorId}"]`);
        const isChecked = vendorCheckbox.checked;

        // Select all transaction checkboxes for this vendor
        const transactionCheckboxes = document.querySelectorAll(`.transaction-row[data-vendor="${vendorId}"] .trans-checkbox`);
        transactionCheckboxes.forEach(cb => {
            cb.checked = isChecked;
        });
    }

    // ============================================================================
    // CHART FILTERING
    // ============================================================================
    function filterCharts(filter) {
        currentChartFilter = filter;

        // Reset all buttons to default color-coded states
        const allBtn = document.getElementById('chartFilterAll');
        const greenBtn = document.getElementById('chartFilterGreen');
        const redBtn = document.getElementById('chartFilterRed');
        const yellowBtn = document.getElementById('chartFilterYellow');
        const reclassBtn = document.getElementById('chartFilterReclass');

        // Reset styling
        if (allBtn) {
            allBtn.style.background = '#ecf0f1';
            allBtn.style.color = '#2c3e50';
            allBtn.style.fontWeight = 'normal';
        }
        if (greenBtn) {
            greenBtn.style.background = '#d4edda';
            greenBtn.style.color = '#155724';
            greenBtn.style.fontWeight = 'normal';
        }
        if (redBtn) {
            redBtn.style.background = '#f8d7da';
            redBtn.style.color = '#721c24';
            redBtn.style.fontWeight = 'normal';
        }
        if (yellowBtn) {
            yellowBtn.style.background = '#fff3cd';
            yellowBtn.style.color = '#856404';
            yellowBtn.style.fontWeight = 'normal';
        }
        if (reclassBtn) {
            reclassBtn.style.background = '#e8daef';
            reclassBtn.style.color = '#4a235a';
            reclassBtn.style.fontWeight = 'normal';
        }

        // Highlight active button
        if (filter === 'all' && allBtn) {
            allBtn.style.background = '#3498db';
            allBtn.style.color = 'white';
            allBtn.style.fontWeight = 'bold';
        } else if (filter === 'green' && greenBtn) {
            greenBtn.style.background = '#27ae60';
            greenBtn.style.color = 'white';
            greenBtn.style.fontWeight = 'bold';
        } else if (filter === 'red' && redBtn) {
            redBtn.style.background = '#e74c3c';
            redBtn.style.color = 'white';
            redBtn.style.fontWeight = 'bold';
        } else if (filter === 'yellow' && yellowBtn) {
            yellowBtn.style.background = '#f39c12';
            yellowBtn.style.color = 'white';
            yellowBtn.style.fontWeight = 'bold';
        } else if (filter === 'reclass' && reclassBtn) {
            reclassBtn.style.background = '#8e44ad';
            reclassBtn.style.color = 'white';
            reclassBtn.style.fontWeight = 'bold';
        }

        updateCharts();
    }

    function filterByType(type) {
        currentTypeFilter = type;

        // Reset all type filter buttons
        const allBtn = document.getElementById('typeFilterAll');
        const ccBtn = document.getElementById('typeFilterCC');
        const bankBtn = document.getElementById('typeFilterBank');

        if (allBtn) {
            allBtn.style.background = '#ecf0f1';
            allBtn.style.color = '#2c3e50';
            allBtn.style.fontWeight = 'normal';
        }
        if (ccBtn) {
            ccBtn.style.background = '#ecf0f1';
            ccBtn.style.color = '#2c3e50';
            ccBtn.style.fontWeight = 'normal';
        }
        if (bankBtn) {
            bankBtn.style.background = '#ecf0f1';
            bankBtn.style.color = '#2c3e50';
            bankBtn.style.fontWeight = 'normal';
        }

        // Highlight active button
        if (type === 'all' && allBtn) {
            allBtn.style.background = '#3498db';
            allBtn.style.color = 'white';
            allBtn.style.fontWeight = 'bold';
        } else if (type === 'Credit Card' && ccBtn) {
            ccBtn.style.background = '#3498db';
            ccBtn.style.color = 'white';
            ccBtn.style.fontWeight = 'bold';
        } else if (type === 'Bank' && bankBtn) {
            bankBtn.style.background = '#3498db';
            bankBtn.style.color = 'white';
            bankBtn.style.fontWeight = 'bold';
        }

        updateCharts();
    }

    function setChartView(view) {
        chartView = view;

        // Reset view buttons
        const quarterlyBtn = document.getElementById('viewQuarterly');
        const annualBtn = document.getElementById('viewAnnual');

        if (quarterlyBtn) {
            quarterlyBtn.style.background = '#ecf0f1';
            quarterlyBtn.style.color = '#2c3e50';
            quarterlyBtn.style.fontWeight = 'normal';
        }
        if (annualBtn) {
            annualBtn.style.background = '#ecf0f1';
            annualBtn.style.color = '#2c3e50';
            annualBtn.style.fontWeight = 'normal';
        }

        // Highlight active button
        if (view === 'quarterly' && quarterlyBtn) {
            quarterlyBtn.style.background = '#3498db';
            quarterlyBtn.style.color = 'white';
            quarterlyBtn.style.fontWeight = 'bold';
        } else if (view === 'annual' && annualBtn) {
            annualBtn.style.background = '#3498db';
            annualBtn.style.color = 'white';
            annualBtn.style.fontWeight = 'bold';
        }

        updateCharts();
    }

    // ============================================================================
    // QUICK STATUS UPDATE
    // ============================================================================
    function quickStatus(transId, status, event) {
        if (event) event.stopPropagation();

        const trans = allData.find(t => t.id === transId);
        if (trans) {
            trans.status = status;

            reviewState[transId] = {
                ...reviewState[transId],
                status: status,
                reviewDate: new Date().toISOString(),
                quickReview: true
            };

            safeLocalStorageSet('cpaForensicReviewState', reviewState);
            groupByVendor();
            updateDashboard();
        }
    }

    // ============================================================================
    // BATCH OPERATIONS
    // ============================================================================
    function batchAccept() {
        batchUpdateStatus('green');
    }

    function batchReject() {
        batchUpdateStatus('red');
    }

    function batchUpdateStatus(status) {
        const checked = document.querySelectorAll('.trans-checkbox:checked');
        if (checked.length === 0) {
            alert('No transactions selected');
            return;
        }

        if (!confirm(`Update ${checked.length} transactions to ${status}?`)) {
            return;
        }

        checked.forEach(cb => {
            const transId = cb.dataset.transId;
            quickStatus(transId, status);
        });

        alert(`${checked.length} transactions updated`);
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================
    function navigateToNext(unreviewed = false) {
        let transactions = allData;
        if (unreviewed) {
            transactions = allData.filter(t => t.status === 'gray');
        }

        if (transactions.length === 0) {
            alert('No unreviewed transactions');
            return;
        }

        const currentIndex = currentSelectedTransaction ?
            transactions.findIndex(t => t.id === currentSelectedTransaction) : -1;

        const nextIndex = (currentIndex + 1) % transactions.length;
        selectTransaction(transactions[nextIndex].id);
    }

    function navigateToPrevious() {
        const currentIndex = currentSelectedTransaction ?
            allData.findIndex(t => t.id === currentSelectedTransaction) : -1;

        const prevIndex = currentIndex <= 0 ? allData.length - 1 : currentIndex - 1;
        selectTransaction(allData[prevIndex].id);
    }

    // ============================================================================
    // REVIEW MODAL
    // ============================================================================
    function openReviewModal(transId, event) {
        if (event) event.stopPropagation();

        currentTransactionId = transId;
        const trans = allData.find(t => t.id === transId);
        const review = reviewState[transId] || {};

        // Use textContent for security
        const infoDiv = document.getElementById('modalTransactionInfo');
        infoDiv.textContent = `${trans.vendor} | Date: ${trans.date.toLocaleDateString()} | Amount: $${Math.abs(trans.amount).toLocaleString('en-US', {minimumFractionDigits: 2})} | Risk: ${trans.riskScore}`;

        document.getElementById('reviewDecision').value = review.status || trans.status || '';
        document.getElementById('reviewCategory').value = review.category || '';
        document.getElementById('reviewNotes').value = review.notes || '';
        document.getElementById('charCount').textContent = (review.notes || '').length;

        // Show existing attachments
        updateModalAttachmentList(transId);

        document.getElementById('reviewModal').style.display = 'block';
    }

    function updateModalAttachmentList(transId) {
        const attachmentDiv = document.getElementById('modalAttachmentList');
        const attachments = pdfAttachments[transId] || [];

        if (attachments.length === 0) {
            attachmentDiv.innerHTML = '<em style="color: #95a5a6;">No documents attached</em>';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
        attachments.forEach((att, idx) => {
            const confidenceColor = att.matchScore >= 80 ? '#27ae60' : att.matchScore >= 50 ? '#f39c12' : '#e74c3c';
            const confidenceText = att.matchScore >= 80 ? 'High' : att.matchScore >= 50 ? 'Med' : 'Low';

            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="flex: 1;">
                        <strong style="color: #2c3e50;">üìÑ ${escapeHtml(att.name)}</strong>
                        ${att.matchScore ? `<span style="margin-left: 10px; font-size: 11px; color: ${confidenceColor}; font-weight: bold;">${confidenceText} ${att.matchScore}%</span>` : ''}
                        <div style="font-size: 11px; color: #7f8c8d;">Uploaded: ${new Date(att.uploadDate).toLocaleDateString()}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button type="button" onclick="previewAttachment('${transId}', ${idx}); event.stopPropagation();" style="padding: 5px 10px; font-size: 12px; background: var(--color-info);">üëÅÔ∏è View</button>
                        <button type="button" onclick="deleteAttachment('${transId}', ${idx}); event.stopPropagation();" style="padding: 5px 10px; font-size: 12px; background: var(--color-danger);">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        attachmentDiv.innerHTML = html;
    }

    function closeModal() {
        document.getElementById('reviewModal').style.display = 'none';
        currentTransactionId = null;
    }

    function saveReview() {
        const status = document.getElementById('reviewDecision').value;
        const category = document.getElementById('reviewCategory').value;
        let notes = document.getElementById('reviewNotes').value;

        if (!status) {
            alert('Please select a review status');
            return;
        }

        // Validate and sanitize
        notes = notes.substring(0, 5000);

        const trans = allData.find(t => t.id === currentTransactionId);
        if (trans) {
            trans.status = status;

            reviewState[currentTransactionId] = {
                status: status,
                category: category,
                notes: notes,
                reviewDate: new Date().toISOString(),
                reviewer: 'CPA Review'
            };

            safeLocalStorageSet('cpaForensicReviewState', reviewState);
            groupByVendor();
            updateDashboard();
            closeModal();
        }
    }

    // ============================================================================
    // PDF MANAGEMENT
    // ============================================================================
    async function handleBulkPdfUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        showLoading(`Processing ${files.length} PDFs...`);

        let matchedCount = 0;
        const statusDiv = document.getElementById('pdfUploadStatus');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            try {
                // Convert to base64 for storage
                const base64 = await fileToBase64(file);

                // Match to transaction
                const matchResult = await matchPdfToTransaction(file, base64);

                if (matchResult.matched) {
                    matchedCount++;

                    if (!pdfAttachments[matchResult.transactionId]) {
                        pdfAttachments[matchResult.transactionId] = [];
                    }

                    pdfAttachments[matchResult.transactionId].push({
                        name: file.name,
                        data: base64,
                        uploadDate: new Date().toISOString(),
                        matchScore: matchResult.score
                    });
                }
            } catch (err) {
                console.error('PDF processing error:', err);
            }
        }

        safeLocalStorageSet('pdfAttachments', pdfAttachments);

        if (statusDiv) {
            statusDiv.textContent = `Matched ${matchedCount} of ${files.length} PDFs`;
        }

        updateVendorTable();
        updateDocumentStats();
        hideLoading();
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function matchPdfToTransaction(file, base64Data) {
        const fileName = file.name.toLowerCase().replace('.pdf', '');

        let bestMatch = null;
        let bestScore = 0;

        allData.forEach(trans => {
            let score = 0;
            const vendorLower = trans.vendor.toLowerCase().replace(/[^a-z0-9]/g, '');
            const cleanFileName = fileName.replace(/[^a-z0-9]/g, '');

            // Vendor name match
            if (cleanFileName.includes(vendorLower)) {
                score += 50;
            }

            // Amount match
            const amountStr = Math.abs(trans.amount).toFixed(0);
            if (cleanFileName.includes(amountStr)) {
                score += 30;
            }

            // Date match
            const month = String(trans.date.getMonth() + 1).padStart(2, '0');
            const day = String(trans.date.getDate()).padStart(2, '0');
            const year = String(trans.date.getFullYear());

            if (cleanFileName.includes(month + day) || cleanFileName.includes(year)) {
                score += 20;
            }

            if (score > bestScore && score >= 50) {
                bestScore = score;
                bestMatch = trans;
            }
        });

        if (bestMatch) {
            return {
                matched: true,
                transactionId: bestMatch.id,
                vendor: bestMatch.vendor,
                amount: bestMatch.amount,
                score: bestScore
            };
        }

        return { matched: false };
    }

    function showAttachments(transId) {
        const attachments = pdfAttachments[transId];
        if (!attachments || attachments.length === 0) {
            alert('No attachments');
            return;
        }

        let message = `Attachments (${attachments.length}):\n\n`;
        attachments.forEach((att, idx) => {
            message += `${idx + 1}. ${att.name} (Score: ${att.matchScore})\n`;
        });

        if (confirm(message + '\nDownload all?')) {
            attachments.forEach(att => {
                const link = document.createElement('a');
                link.href = att.data;
                link.download = att.name;
                link.click();
            });
        }
    }

    // ============================================================================
    // MODAL PDF UPLOAD
    // ============================================================================
    async function handleModalPdfUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0 || !currentTransactionId) return;

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Convert to base64
                const base64 = await fileToBase64(file);

                // Initialize attachment array if needed
                if (!pdfAttachments[currentTransactionId]) {
                    pdfAttachments[currentTransactionId] = [];
                }

                // Add attachment (no auto-matching, manual upload = 100% confidence)
                pdfAttachments[currentTransactionId].push({
                    name: file.name,
                    data: base64,
                    uploadDate: new Date().toISOString(),
                    matchScore: 100 // Manual upload = perfect match
                });
            }

            // Save to localStorage
            safeLocalStorageSet('pdfAttachments', pdfAttachments);

            // Update the attachment list display
            updateModalAttachmentList(currentTransactionId);

            // Update vendor table to show new attachment count
            updateVendorTable();
            updateDocumentStats();

            // Clear the file input
            event.target.value = '';

            alert(`‚úÖ ${files.length} document(s) uploaded successfully`);
        } catch (err) {
            console.error('PDF upload error:', err);
            alert('‚ùå Error uploading PDF. Please try again.');
        }
    }

    function deleteAttachment(transId, attachmentIndex) {
        if (!confirm('Delete this document?')) return;

        const attachments = pdfAttachments[transId];
        if (!attachments || attachmentIndex >= attachments.length) return;

        // Remove the attachment
        attachments.splice(attachmentIndex, 1);

        // If no more attachments, remove the entry
        if (attachments.length === 0) {
            delete pdfAttachments[transId];
        }

        // Save to localStorage
        safeLocalStorageSet('pdfAttachments', pdfAttachments);

        // Update displays
        updateModalAttachmentList(transId);
        updateVendorTable();
        updateDocumentStats();
    }

    // ============================================================================
    // PDF PREVIEW
    // ============================================================================
    let currentPdfData = null;

    function previewAttachment(transId, attachmentIndex = 0) {
        const attachments = pdfAttachments[transId];
        if (!attachments || attachments.length === 0) {
            alert('No attachments found');
            return;
        }

        const trans = allData.find(t => t.id === transId);
        const attachment = attachments[attachmentIndex];

        if (!attachment) {
            alert('Attachment not found');
            return;
        }

        // Store current PDF data for download
        currentPdfData = attachment;

        // Set preview info
        const confidenceColor = attachment.matchScore >= 80 ? '#27ae60' :
                                attachment.matchScore >= 50 ? '#f39c12' : '#e74c3c';
        const confidenceText = attachment.matchScore >= 80 ? 'High Confidence' :
                              attachment.matchScore >= 50 ? 'Medium Confidence' : 'Low Confidence';

        document.getElementById('pdfPreviewTitle').textContent = `üìÑ ${attachment.name}`;
        document.getElementById('pdfPreviewInfo').innerHTML = `
            <strong>Transaction:</strong> ${escapeHtml(trans.vendor)} - $${Math.abs(trans.amount).toLocaleString('en-US', {minimumFractionDigits: 2})} on ${trans.date.toLocaleDateString()}
            <br>
            <strong>Match Confidence:</strong> <span style="color: ${confidenceColor}; font-weight: bold;">${confidenceText} (${attachment.matchScore}%)</span>
            <br>
            <strong>Uploaded:</strong> ${new Date(attachment.uploadDate).toLocaleString()}
            ${attachments.length > 1 ? `<br><strong>Note:</strong> ${attachments.length} files attached - showing first file. <a href="#" onclick="showAttachments('${transId}'); return false;">View all</a>` : ''}
        `;

        // Load PDF in iframe
        const iframe = document.getElementById('pdfPreviewFrame');
        iframe.src = attachment.data;

        // Show modal
        document.getElementById('pdfPreviewModal').style.display = 'block';
    }

    function closePdfPreview() {
        document.getElementById('pdfPreviewModal').style.display = 'none';
        document.getElementById('pdfPreviewFrame').src = '';
        currentPdfData = null;
    }

    function downloadCurrentPdf() {
        if (!currentPdfData) {
            alert('No PDF loaded');
            return;
        }

        const link = document.createElement('a');
        link.href = currentPdfData.data;
        link.download = currentPdfData.name;
        link.click();
    }

    // ============================================================================
    // STATUS BY YEAR OVERLAY
    // ============================================================================
    let statusByYearChartInstance = null;

    function showStatusByYearOverlay() {
        // Aggregate data by year and status
        const yearlyData = {};

        allData.forEach(trans => {
            const year = trans.date.getFullYear();
            if (!yearlyData[year]) {
                yearlyData[year] = {
                    green: 0,
                    red: 0,
                    yellow: 0,
                    gray: 0,
                    reclass: 0
                };
            }
            yearlyData[year][trans.status]++;
        });

        // Sort years
        const years = Object.keys(yearlyData).sort();

        // Prepare datasets for each status
        const datasets = [
            {
                label: 'Mission (Green)',
                data: years.map(y => yearlyData[y].green),
                backgroundColor: '#27ae60',
                borderColor: '#229954',
                borderWidth: 1
            },
            {
                label: 'Non-Mission (Red)',
                data: years.map(y => yearlyData[y].red),
                backgroundColor: '#e74c3c',
                borderColor: '#c0392b',
                borderWidth: 1
            },
            {
                label: 'Review (Yellow)',
                data: years.map(y => yearlyData[y].yellow),
                backgroundColor: '#f39c12',
                borderColor: '#d68910',
                borderWidth: 1
            },
            {
                label: 'Reclass to Revenue (Purple)',
                data: years.map(y => yearlyData[y].reclass),
                backgroundColor: '#8e44ad',
                borderColor: '#6c3483',
                borderWidth: 1
            },
            {
                label: 'Unreviewed (Gray)',
                data: years.map(y => yearlyData[y].gray),
                backgroundColor: '#95a5a6',
                borderColor: '#7f8c8d',
                borderWidth: 1
            }
        ];

        // Show modal
        document.getElementById('statusByYearModal').style.display = 'flex';

        // Destroy existing chart if it exists
        if (statusByYearChartInstance) {
            statusByYearChartInstance.destroy();
        }

        // Create chart
        const ctx = document.getElementById('statusByYearChart');
        statusByYearChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    datalabels: {
                        display: true,
                        color: 'white',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: (value) => {
                            return value > 0 ? value : '';
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Number of Transactions'
                        },
                        beginAtZero: true
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function closeStatusByYearOverlay() {
        document.getElementById('statusByYearModal').style.display = 'none';
        if (statusByYearChartInstance) {
            statusByYearChartInstance.destroy();
            statusByYearChartInstance = null;
        }
    }

    function updateDocumentStats() {
        const matched = Object.keys(pdfAttachments).length;
        const totalTransactions = allData.length;
        const missing = totalTransactions - matched;

        const matchedEl = document.getElementById('docsMatched');
        const unmatchedEl = document.getElementById('docsUnmatched');
        const missingEl = document.getElementById('docsMissing');

        if (matchedEl) matchedEl.textContent = matched;
        if (missingEl) missingEl.textContent = missing;
    }

    // ============================================================================
    // FORENSIC ANALYSIS
    // ============================================================================
    function runForensicAnalysis() {
        if (allData.length === 0) return;

        const alerts = [];

        // Duplicate detection
        const duplicates = findDuplicates();
        if (duplicates.length > 0) {
            alerts.push({
                level: 'high',
                message: `üö® ${duplicates.length} potential duplicate transactions detected`
            });
        }

        // Weekend clustering
        const weekendTrans = allData.filter(t => t.date.getDay() === 0 || t.date.getDay() === 6);
        if (weekendTrans.length > allData.length * 0.15) {
            alerts.push({
                level: 'medium',
                message: `‚ö†Ô∏è ${weekendTrans.length} weekend transactions (${((weekendTrans.length/allData.length)*100).toFixed(1)}%)`
            });
        }

        // Round amounts
        const roundAmounts = allData.filter(t => Math.abs(t.amount) % 1000 === 0);
        if (roundAmounts.length > allData.length * 0.20) {
            alerts.push({
                level: 'medium',
                message: `‚ö†Ô∏è ${roundAmounts.length} round-dollar transactions (${((roundAmounts.length/allData.length)*100).toFixed(1)}%)`
            });
        }

        // High-risk vendors
        const highRiskVendors = Object.entries(vendorGroups)
            .filter(([, data]) => data.avgRisk >= 7);
        if (highRiskVendors.length > 0) {
            alerts.push({
                level: 'high',
                message: `üö® ${highRiskVendors.length} high-risk vendors identified`
            });
        }

        displayForensicAlerts(alerts);
        runBenfordsLaw();
        displayDuplicates(duplicates);
    }

    function findDuplicates() {
        const duplicates = [];
        const seen = new Map();

        allData.forEach(trans => {
            const key = `${trans.vendor}_${trans.amount.toFixed(2)}_${trans.date.toDateString()}`;

            if (seen.has(key)) {
                duplicates.push({
                    original: seen.get(key),
                    duplicate: trans
                });
            } else {
                seen.set(key, trans);
            }
        });

        return duplicates;
    }

    function displayForensicAlerts(alerts) {
        const container = document.getElementById('forensicAlerts');
        if (!container) return;

        if (alerts.length === 0) {
            container.innerHTML = '<p style="color: #27ae60;">‚úÖ No major forensic alerts detected</p>';
            return;
        }

        let html = '';
        alerts.forEach(alert => {
            const escapedMsg = escapeHtml(alert.message);
            html += `<div class="alert-item ${alert.level}">${escapedMsg}</div>`;
        });

        container.innerHTML = html;
    }

    function runBenfordsLaw() {
        const firstDigits = allData
            .filter(t => Math.abs(t.amount) >= 1)
            .map(t => parseInt(String(Math.abs(t.amount))[0]));

        const counts = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
        firstDigits.forEach(d => counts[d]++);

        const actual = Object.values(counts).map(c => (c / firstDigits.length) * 100);
        const expected = [30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6];

        const benfordCtx = document.getElementById('benfordChart');
        if (benfordCtx) {
            charts.benford = new Chart(benfordCtx, {
                type: 'bar',
                data: {
                    labels: ['1','2','3','4','5','6','7','8','9'],
                    datasets: [
                        {
                            label: 'Actual',
                            data: actual,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)'
                        },
                        {
                            label: 'Expected (Benford)',
                            data: expected,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Percentage (%)' }
                        },
                        x: {
                            title: { display: true, text: 'First Digit' }
                        }
                    }
                }
            });
        }
    }

    function displayDuplicates(duplicates) {
        const container = document.getElementById('duplicateList');
        if (!container) return;

        if (duplicates.length === 0) {
            container.innerHTML = '<p style="color: #27ae60;">‚úÖ No duplicate transactions detected</p>';
            return;
        }

        let html = '<div style="font-weight: bold; margin-bottom: 10px;">Potential Duplicates:</div>';
        duplicates.forEach((dup, idx) => {
            const escapedVendor = escapeHtml(dup.original.vendor);
            html += `
                <div style="padding: 10px; margin: 5px 0; background: #fff3cd; border-radius: 4px; font-size: 13px;">
                    ${idx + 1}. ${escapedVendor} - $${Math.abs(dup.original.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                    <br><span style="font-size: 11px; color: #856404;">
                    ${dup.original.date.toLocaleDateString()} & ${dup.duplicate.date.toLocaleDateString()}
                    </span>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // ============================================================================
    // TAB SWITCHING
    // ============================================================================
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }

        if (tabName === 'forensics' && allData.length > 0) {
            runForensicAnalysis();
        }
        if (tabName === 'documents') {
            updateDocumentStats();
        }
    }

    // ============================================================================
    // EXPORT FUNCTIONS
    // ============================================================================
    function exportAuditReport() {
        if (allData.length === 0) {
            alert('No data to export');
            return;
        }

        showLoading('Generating audit report...');

        setTimeout(() => {
            const reportData = allData.map(trans => {
                const review = reviewState[trans.id] || {};
                return {
                    'Transaction ID': trans.id,
                    'Date': trans.date.toLocaleDateString(),
                    'Vendor': trans.vendor,
                    'Amount': trans.amount,
                    'Description': trans.description,
                    'Status': trans.status,
                    'Risk Score': trans.riskScore,
                    'Review Category': review.category || '',
                    'Review Notes': review.notes || '',
                    'Attachments': pdfAttachments[trans.id] ? pdfAttachments[trans.id].length : 0
                };
            });

            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
            XLSX.writeFile(wb, `Audit_Report_${new Date().toISOString().slice(0,10)}.xlsx`);

            hideLoading();
        }, 500);
    }

    function exportManagementLetter() {
        alert('Management Letter export feature coming soon');
    }

    function exportExceptionReport() {
        const exceptions = allData.filter(t => t.status === 'red' || t.riskScore >= 7);

        if (exceptions.length === 0) {
            alert('No exceptions to export');
            return;
        }

        const reportData = exceptions.map(trans => ({
            'Date': trans.date.toLocaleDateString(),
            'Vendor': trans.vendor,
            'Amount': trans.amount,
            'Status': trans.status,
            'Risk Score': trans.riskScore,
            'Description': trans.description
        }));

        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Exceptions");
        XLSX.writeFile(wb, `Exception_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function exportComplianceReport() {
        alert('Compliance Report export feature coming soon');
    }

    // ============================================================================
    // JOURNAL ENTRY GENERATOR
    // ============================================================================
    let currentJETransaction = null;
    let jeCounter = safeLocalStorageGet('jeCounter', 1);

    function openJEModal(transId, event) {
        if (event) event.stopPropagation();

        currentJETransaction = allData.find(t => t.id === transId);
        if (!currentJETransaction) return;

        // Populate transaction info
        const infoDiv = document.getElementById('jeTransactionInfo');
        infoDiv.textContent = `Transaction: ${currentJETransaction.vendor} | Date: ${currentJETransaction.date.toLocaleDateString()} | Amount: $${Math.abs(currentJETransaction.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}`;

        // Auto-fill memo
        document.getElementById('jeMemo').value = `Reclassify TXN ${currentJETransaction.id.substring(0, 20)} - ${currentJETransaction.description.substring(0, 50)}`;

        // Clear accounts
        document.getElementById('jeDebitAccount').value = '';
        document.getElementById('jeCreditAccount').value = '';

        // Show modal
        document.getElementById('jeModal').style.display = 'block';

        // Update preview
        setTimeout(updateJEPreview, 100);
    }

    function closeJEModal() {
        document.getElementById('jeModal').style.display = 'none';
        currentJETransaction = null;
    }

    function updateJETemplate() {
        // Update preview when template changes
        updateJEPreview();
    }

    function updateJEPreview() {
        if (!currentJETransaction) return;

        const type = document.getElementById('jeType').value;
        const debitAcct = document.getElementById('jeDebitAccount').value || '[Debit Account]';
        const creditAcct = document.getElementById('jeCreditAccount').value || '[Credit Account]';
        const memo = document.getElementById('jeMemo').value;
        const amount = Math.abs(currentJETransaction.amount);

        const jeNumber = `JE-${new Date().getFullYear()}-${String(jeCounter).padStart(4, '0')}`;
        const jeDate = currentJETransaction.date.toLocaleDateString();

        let preview = ``;
        preview += `Journal Entry: ${jeNumber}\n`;
        preview += `Date: ${jeDate}\n`;
        preview += `Type: ${type.charAt(0).toUpperCase() + type.slice(1)}\n`;
        preview += `\n`;
        preview += `Account                                    Debit        Credit\n`;
        preview += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;

        if (type === 'reversal') {
            // Reversal - credit first, then debit
            preview += `${creditAcct.padEnd(40)} `.padEnd(55) + `$${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
            preview += `  ${debitAcct.padEnd(38)}`.padEnd(42) + `$${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
        } else {
            // Normal - debit first, then credit
            preview += `${debitAcct.padEnd(40)} $${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
            preview += `  ${creditAcct.padEnd(38)}`.padEnd(55) + `$${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
        }

        preview += `\n`;
        preview += `Memo: ${memo}\n`;
        preview += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        preview += `Total:                                     $${amount.toLocaleString('en-US', {minimumFractionDigits: 2})} $${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;

        document.getElementById('jePreview').textContent = preview;
    }

    // Real-time preview updates
    document.addEventListener('DOMContentLoaded', function() {
        const jeInputs = ['jeDebitAccount', 'jeCreditAccount', 'jeMemo'];
        jeInputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateJEPreview);
            }
        });
    });

    function copyJEToClipboard() {
        const preview = document.getElementById('jePreview').textContent;
        navigator.clipboard.writeText(preview).then(() => {
            alert('‚úÖ Journal Entry copied to clipboard!');
        }).catch(err => {
            console.error('Copy failed:', err);
            // Fallback
            const textArea = document.createElement('textarea');
            textArea.value = preview;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('‚úÖ Journal Entry copied to clipboard!');
        });
    }

    function downloadJEAsCSV() {
        if (!currentJETransaction) return;

        const type = document.getElementById('jeType').value;
        const debitAcct = document.getElementById('jeDebitAccount').value || '[Debit Account]';
        const creditAcct = document.getElementById('jeCreditAccount').value || '[Credit Account]';
        const memo = document.getElementById('jeMemo').value;
        const amount = Math.abs(currentJETransaction.amount);
        const jeNumber = `JE-${new Date().getFullYear()}-${String(jeCounter).padStart(4, '0')}`;
        const jeDate = currentJETransaction.date.toLocaleDateString('en-US');

        // QuickBooks CSV format
        let csv = 'Journal Entry Number,Date,Account,Debit,Credit,Memo\n';

        if (type === 'reversal') {
            csv += `${jeNumber},${jeDate},${creditAcct},,${amount.toFixed(2)},${memo}\n`;
            csv += `${jeNumber},${jeDate},${debitAcct},${amount.toFixed(2)},,${memo}\n`;
        } else {
            csv += `${jeNumber},${jeDate},${debitAcct},${amount.toFixed(2)},,${memo}\n`;
            csv += `${jeNumber},${jeDate},${creditAcct},,${amount.toFixed(2)},${memo}\n`;
        }

        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${jeNumber}_${currentJETransaction.vendor.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
        link.click();
        URL.revokeObjectURL(url);

        // Increment counter
        jeCounter++;
        safeLocalStorageSet('jeCounter', jeCounter);

        alert('‚úÖ CSV downloaded! Import into QuickBooks.');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.id === 'reviewModal') {
            closeModal();
        }
        if (event.target.id === 'jeModal') {
            closeJEModal();
        }
        if (event.target.id === 'pdfPreviewModal') {
            closePdfPreview();
        }
        if (event.target.id === 'shortcutsHelp') {
            toggleShortcutsHelp();
        }
    };

    </script>
</body>
</html>
