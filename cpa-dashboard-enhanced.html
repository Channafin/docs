<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Forensic Analysis Dashboard - Enhanced Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --color-primary: #3498db;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #16a085;
            --color-secondary: #95a5a6;
            --color-dark: #2c3e50;
            --color-light: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--color-dark) 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header .version-badge {
            position: absolute;
            top: 20px;
            right: 30px;
            background: var(--color-success);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
        }

        .shortcuts-help.active {
            display: block;
        }

        .shortcuts-help h3 {
            margin-bottom: 20px;
            color: var(--color-dark);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--color-light);
        }

        .shortcut-key {
            background: var(--color-dark);
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        .population-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--color-primary);
        }

        .stat-card.total { border-left-color: var(--color-dark); }
        .stat-card.amount { border-left-color: var(--color-success); }
        .stat-card.vendors { border-left-color: #8e44ad; }
        .stat-card.period { border-left-color: var(--color-warning); }
        .stat-card.reviewed { border-left-color: var(--color-info); }
        .stat-card.risk { border-left-color: var(--color-danger); }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #7f8c8d;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-dark);
        }

        .stat-subtext {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 3px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-light);
            background: white;
            padding: 10px 20px 0;
            border-radius: 12px 12px 0 0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--color-dark);
            border-bottom-color: var(--color-primary);
        }

        .tab:hover {
            color: #34495e;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 12px 12px;
            margin-top: -20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 450px;
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 15px;
        }

        canvas {
            max-height: 380px !important;
            width: 100% !important;
        }

        /* Vendor Table */
        .vendor-pivot {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .vendor-row {
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }

        .vendor-row:hover {
            background: #e8ecef;
        }

        .vendor-row td {
            padding: 12px;
            border-top: 1px solid #dee2e6;
            font-weight: 600;
        }

        .vendor-row .expand-icon {
            display: inline-block;
            width: 20px;
            transition: transform 0.2s;
        }

        .vendor-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .transaction-row {
            display: none;
            background: white;
        }

        .transaction-row.visible {
            display: table-row;
        }

        .transaction-row.selected {
            background: #e3f2fd;
            border-left: 4px solid var(--color-primary);
        }

        .transaction-row td {
            padding: 10px 12px 10px 40px;
            border-top: 1px solid #f1f3f5;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-green { background: var(--color-success); }
        .status-red { background: var(--color-danger); }
        .status-yellow { background: var(--color-warning); }
        .status-gray { background: var(--color-secondary); }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-green {
            background: linear-gradient(135deg, var(--color-success) 0%, #229954 100%);
        }

        .btn-red {
            background: linear-gradient(135deg, var(--color-danger) 0%, #c0392b 100%);
        }

        .btn-yellow {
            background: linear-gradient(135deg, var(--color-warning) 0%, #e67e22 100%);
        }

        /* Forensic Alerts */
        .alert-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .alert-item {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item.high {
            background: #fee;
            border-left-color: var(--color-danger);
        }

        .alert-item.medium {
            background: #fff3cd;
            border-left-color: var(--color-warning);
        }

        .alert-item.low {
            background: #d1ecf1;
            border-left-color: var(--color-info);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--color-secondary);
        }

        .close:hover {
            color: var(--color-dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        .form-group textarea,
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        @media print {
            .controls, .tabs, .action-buttons, .shortcuts-help {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div>
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div id="shortcutsHelp" class="shortcuts-help">
        <span class="close" onclick="toggleShortcutsHelp()">&times;</span>
        <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Accept Transaction</span>
            <span class="shortcut-key">A</span>
        </div>
        <div class="shortcut-item">
            <span>Reject Transaction</span>
            <span class="shortcut-key">R</span>
        </div>
        <div class="shortcut-item">
            <span>Review Transaction</span>
            <span class="shortcut-key">Y</span>
        </div>
        <div class="shortcut-item">
            <span>Next Unreviewed</span>
            <span class="shortcut-key">N</span>
        </div>
        <div class="shortcut-item">
            <span>Previous Transaction</span>
            <span class="shortcut-key">P</span>
        </div>
        <div class="shortcut-item">
            <span>Open Detail Modal</span>
            <span class="shortcut-key">Space</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Help</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>

    <div class="header">
        <h1>CPA Forensic Analysis Dashboard - Enhanced Edition</h1>
        <p class="subtitle">Advanced Transaction Review System | Tampa Bay Trial Lawyers Association</p>
        <div class="version-badge">v7.0 Enhanced</div>
    </div>

    <div class="container">
        <!-- Population Statistics -->
        <div class="population-stats">
            <h2 style="margin-bottom: 20px; color: var(--color-dark);">Complete Transaction Population Overview</h2>
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-value" id="totalTransactions">-</div>
                    <div class="stat-subtext" id="transactionPeriod">Loading...</div>
                </div>
                <div class="stat-card amount">
                    <div class="stat-label">Total Amount</div>
                    <div class="stat-value" id="totalAmount">-</div>
                    <div class="stat-subtext" id="avgTransaction">Avg: -</div>
                </div>
                <div class="stat-card vendors">
                    <div class="stat-label">Unique Vendors</div>
                    <div class="stat-value" id="uniqueVendors">-</div>
                    <div class="stat-subtext" id="topVendor">Top: -</div>
                </div>
                <div class="stat-card period">
                    <div class="stat-label">Date Range</div>
                    <div class="stat-value" id="dateRange" style="font-size: 16px;">-</div>
                    <div class="stat-subtext" id="daysCovered">- days</div>
                </div>
                <div class="stat-card reviewed">
                    <div class="stat-label">Review Progress</div>
                    <div class="stat-value" id="reviewProgress">0%</div>
                    <div class="stat-subtext" id="reviewCount">0 of 0 reviewed</div>
                </div>
                <div class="stat-card risk">
                    <div class="stat-label">High Risk Items</div>
                    <div class="stat-value" id="highRiskCount">0</div>
                    <div class="stat-subtext" id="riskAmount">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview & Analysis</button>
            <button class="tab" onclick="switchTab('review')">‚úÖ Transaction Review</button>
            <button class="tab" onclick="switchTab('forensics')">üîç Forensic Insights</button>
            <button class="tab" onclick="switchTab('documents')">üìé Document Management</button>
            <button class="tab" onclick="switchTab('reports')">üìã Reports & Export</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>Upload Transaction File</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" value="2020-01-01">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" value="2025-12-31">
                </div>
                <button onclick="updateDashboard()">üîÑ Refresh Analysis</button>
                <button onclick="toggleShortcutsHelp()">‚å®Ô∏è Keyboard Shortcuts</button>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Review Status Distribution</div>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Transaction Volume</div>
                    <canvas id="volumeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 10 Vendors by Amount</div>
                    <canvas id="vendorChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Risk Score Distribution</div>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Review Tab -->
        <div id="review-tab" class="tab-content">
            <div class="controls">
                <input type="text" id="vendorSearch" placeholder="üîç Search vendors..." style="flex: 1;">
                <button onclick="selectAllVisible()">‚òëÔ∏è Select All</button>
                <button onclick="batchAccept()">‚úÖ Batch Accept</button>
                <button onclick="batchReject()">‚ùå Batch Reject</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="vendor-pivot" id="vendorTable">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 12px; text-align: left;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th style="padding: 12px; text-align: left;">Vendor / Transaction</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">üìé Docs</th>
                            <th style="padding: 12px;">Risk</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 40px; background: #f8f9fa;">
                            <div style="font-size: 18px; margin-bottom: 10px;">üìÅ Load Your Transaction Data</div>
                            <div>Use the <strong>Upload File</strong> button above</div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Forensic Insights Tab -->
        <div id="forensics-tab" class="tab-content">
            <div class="alert-panel">
                <h3 style="margin-bottom: 15px;">üö® Real-time Forensic Alerts</h3>
                <div id="forensicAlerts">
                    <p style="color: #7f8c8d;">Load transaction data to see forensic analysis</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Benford's Law Analysis</div>
                    <canvas id="benfordChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Payment Velocity (Transactions per Vendor)</div>
                    <canvas id="velocityChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Statistical Outliers</div>
                    <canvas id="outlierChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Duplicate Detection</div>
                    <div id="duplicateList" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Document Management Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìé Bulk PDF Upload & Matching</h3>
                <input type="file" id="bulkPdfUpload" multiple accept=".pdf" style="display: none;">
                <button onclick="document.getElementById('bulkPdfUpload').click()" style="margin: 10px 0;">üìÅ Select PDFs to Upload</button>
                <div id="pdfUploadStatus" style="margin-top: 10px;"></div>
            </div>

            <div class="alert-panel">
                <h3>üìä Document Status Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: #d4edda; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMatched">0</div>
                        <div>Matched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsUnmatched">0</div>
                        <div>Unmatched Documents</div>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;" id="docsMissing">0</div>
                        <div>Missing Documentation</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="alert-panel">
                <h3>üìã Generate Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <button onclick="exportAuditReport()">üìä Complete Audit Report</button>
                    <button onclick="exportManagementLetter()">üìù Management Letter</button>
                    <button onclick="exportExceptionReport()">üö® Exception Report Only</button>
                    <button onclick="exportComplianceReport()">‚úÖ Compliance Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Transaction Review</h2>
            <div id="modalTransactionInfo" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>

            <div class="form-group">
                <label>Review Decision</label>
                <select id="reviewDecision">
                    <option value="">-- Select Status --</option>
                    <option value="green">‚úÖ Green - Mission Related</option>
                    <option value="red">‚ùå Red - Non-mission/Suspicious</option>
                    <option value="yellow">‚ö†Ô∏è Yellow - Needs Further Review</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Category</label>
                <select id="reviewCategory">
                    <option value="">-- Select Category --</option>
                    <option value="verified">Verified with Documentation</option>
                    <option value="mission">Mission/Program Related</option>
                    <option value="authorized">Properly Authorized</option>
                    <option value="suspicious">Suspicious - Investigate</option>
                    <option value="duplicate">Duplicate Transaction</option>
                    <option value="personal">Personal/Non-Business</option>
                </select>
            </div>

            <div class="form-group">
                <label>Review Notes (Max 5000 characters)</label>
                <textarea id="reviewNotes" maxlength="5000" placeholder="Enter detailed review notes..."></textarea>
                <div style="text-align: right; font-size: 12px; color: #7f8c8d;">
                    <span id="charCount">0</span>/5000
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeModal()" style="background: var(--color-secondary);">Cancel</button>
                <button onclick="saveReview()">üíæ Save Review</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================================================
    // GLOBAL ERROR HANDLER
    // ============================================================================
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error:', msg, error);
        alert('An error occurred. Please save your work and refresh if needed.');
        return false;
    };

    // ============================================================================
    // SECURITY: HTML ESCAPE FUNCTION
    // ============================================================================
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ============================================================================
    // SAFE LOCALSTORAGE OPERATIONS
    // ============================================================================
    function safeLocalStorageSet(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('localStorage save failed:', e);
            if (e.name === 'QuotaExceededError') {
                alert('Storage is full. Please export your data and clear old reviews.');
            } else {
                alert('Unable to save data. Storage may be disabled.');
            }
            return false;
        }
    }

    function safeLocalStorageGet(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('localStorage read failed:', e);
            return defaultValue;
        }
    }

    // ============================================================================
    // LOADING SPINNER
    // ============================================================================
    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        overlay.classList.add('active');
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('active');
    }

    // ============================================================================
    // KEYBOARD SHORTCUTS
    // ============================================================================
    function toggleShortcutsHelp() {
        const help = document.getElementById('shortcutsHelp');
        help.classList.toggle('active');
    }

    document.addEventListener('keydown', function(e) {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }

        const key = e.key.toLowerCase();

        if (key === '?') {
            toggleShortcutsHelp();
        } else if (key === 'a' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'green', e);
        } else if (key === 'r' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'red', e);
        } else if (key === 'y' && currentSelectedTransaction) {
            quickStatus(currentSelectedTransaction, 'yellow', e);
        } else if (key === 'n') {
            navigateToNext(true);
        } else if (key === 'p') {
            navigateToPrevious();
        } else if (key === ' ' && currentSelectedTransaction) {
            e.preventDefault();
            openReviewModal(currentSelectedTransaction, e);
        }
    });

    // ============================================================================
    // GLOBAL VARIABLES
    // ============================================================================
    let allData = [];
    let vendorGroups = {};
    let reviewState = {};
    let charts = {};
    let currentTransactionId = null;
    let currentSelectedTransaction = null;
    let pdfAttachments = {};
    let chartView = 'monthly';

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    window.onload = function() {
        reviewState = safeLocalStorageGet('cpaForensicReviewState', {});
        pdfAttachments = safeLocalStorageGet('pdfAttachments', {});

        // Set up PDF upload handler
        const bulkUpload = document.getElementById('bulkPdfUpload');
        if (bulkUpload) {
            bulkUpload.addEventListener('change', handleBulkPdfUpload);
        }

        // Character counter for notes
        const notesField = document.getElementById('reviewNotes');
        if (notesField) {
            notesField.addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
        }

        // Register Chart.js plugin properly
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            Chart.defaults.plugins.datalabels.display = false;
        }
    };

    // ============================================================================
    // FILE UPLOAD HANDLER
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                showLoading('Reading Excel file...');

                const reader = new FileReader();
                reader.onload = function(e) {
                    setTimeout(() => {
                        try {
                            showLoading('Processing transactions...');
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});

                            let worksheet;
                            if (workbook.Sheets['Clean']) {
                                worksheet = workbook.Sheets['Clean'];
                            } else {
                                worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            }

                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            processData(jsonData);
                            hideLoading();
                        } catch (err) {
                            console.error('File processing error:', err);
                            alert('Error processing file: ' + err.message);
                            hideLoading();
                        }
                    }, 100);
                };
                reader.onerror = function() {
                    alert('Error reading file');
                    hideLoading();
                };
                reader.readAsArrayBuffer(file);
            });
        }
    });

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function processData(data) {
        allData = data.map((row, index) => {
            // Generate stable transaction ID
            const dateStr = row['Transaction date'] || '';
            const vendor = row['Name V2'] || row['Vendor'] || row['Name'] || 'Unknown';
            const amount = calculateAmount(row);
            const transId = generateStableId(dateStr, vendor, amount, index);

            // Determine initial status
            let initialStatus = 'gray';
            if (row['legitimacy']) {
                initialStatus = parseL egitimacy(row['legitimacy']);
            }

            // Override with saved review state
            if (reviewState[transId]?.status) {
                initialStatus = reviewState[transId].status;
            }

            return {
                id: transId,
                date: parseDate(row['Transaction date']),
                vendor: vendor,
                amount: amount,
                type: row['Transaction type'] || 'Unknown',
                description: row['Memo/Description'] || '',
                account: row['Account name'] || 'Unknown',
                category: row['Item class'] || 'Uncategorized',
                legitimacy: row['legitimacy'] || '',
                status: initialStatus,
                riskScore: calculateRiskScore(row, amount)
            };
        });

        groupByVendor();
        updateDashboard();
        runForensicAnalysis();
    }

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function generateStableId(date, vendor, amount, fallbackIndex) {
        const cleanVendor = vendor.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
        const cleanAmount = Math.abs(amount).toFixed(2).replace('.', '');
        const dateObj = parseDate(date);
        const dateStamp = dateObj.getTime();
        return `TXN_${dateStamp}_${cleanVendor}_${cleanAmount}_${fallbackIndex}`;
    }

    function calculateAmount(row) {
        let amount = 0;
        if (row['Debit'] !== undefined && row['Credit'] !== undefined) {
            const debit = parseFloat(row['Debit']) || 0;
            const credit = parseFloat(row['Credit']) || 0;
            amount = debit - credit;
        } else if (row['Amount'] !== undefined) {
            amount = parseFloat(row['Amount']) || 0;
        }
        return amount;
    }

    function parseLegitimacy(legitValue) {
        const legitStr = String(legitValue).toLowerCase();
        if (legitStr.includes('green') || legitStr.includes('good') || legitStr.includes('mission')) {
            return 'green';
        } else if (legitStr.includes('red') || legitStr.includes('bad') || legitStr.includes('suspicious')) {
            return 'red';
        } else if (legitStr.includes('yellow') || legitStr.includes('review')) {
            return 'yellow';
        }
        return 'gray';
    }

    function parseDate(dateValue) {
        if (!dateValue) return new Date();
        if (typeof dateValue === 'number') {
            return new Date((dateValue - 25569) * 86400 * 1000);
        }
        const parsed = new Date(dateValue);
        if (isNaN(parsed.getTime())) {
            console.warn('Invalid date:', dateValue);
            return new Date();
        }
        return parsed;
    }

    function calculateRiskScore(row, amount) {
        let score = 0;
        const absAmount = Math.abs(amount);
        const date = parseDate(row['Transaction date']);

        // Weekend transaction
        if (date.getDay() === 0 || date.getDay() === 6) score += 2;

        // Round amount
        if (absAmount % 1000 === 0 && absAmount !== 0) score += 1;

        // High amount
        if (absAmount > 10000) score += 3;
        if (absAmount > 50000) score += 5;

        // End of period
        if (date.getDate() >= 28) score += 1;

        // Suspicious vendor patterns
        const vendor = (row['Name V2'] || row['Vendor'] || '').toLowerCase();
        if (vendor.includes('venmo') || vendor.includes('paypal') || vendor.includes('zelle')) {
            score += 3;
        }

        return Math.min(score, 10);
    }

    function groupByVendor() {
        vendorGroups = {};

        allData.forEach(trans => {
            if (!vendorGroups[trans.vendor]) {
                vendorGroups[trans.vendor] = {
                    transactions: [],
                    totalAmount: 0,
                    count: 0,
                    statuses: { green: 0, red: 0, yellow: 0, gray: 0 },
                    avgRisk: 0
                };
            }

            vendorGroups[trans.vendor].transactions.push(trans);
            vendorGroups[trans.vendor].totalAmount += trans.amount;
            vendorGroups[trans.vendor].count++;
            vendorGroups[trans.vendor].statuses[trans.status]++;
        });

        // Calculate average risk per vendor
        Object.keys(vendorGroups).forEach(vendor => {
            const group = vendorGroups[vendor];
            const totalRisk = group.transactions.reduce((sum, t) => sum + t.riskScore, 0);
            group.avgRisk = (totalRisk / group.count).toFixed(1);
        });
    }

    // ============================================================================
    // DASHBOARD UPDATE
    // ============================================================================
    function updateDashboard() {
        updatePopulationStats();
        updateCharts();
        updateVendorTable();
    }

    function updatePopulationStats() {
        const total = allData.length;
        const totalAmt = allData.reduce((sum, t) => sum + t.amount, 0);
        const vendors = Object.keys(vendorGroups).length;
        const highRisk = allData.filter(t => t.riskScore >= 7);
        const reviewed = allData.filter(t => t.status !== 'gray').length;

        // Date range
        const dates = allData.map(d => d.date);
        const minDate = dates.length > 0 ? new Date(Math.min(...dates)) : new Date();
        const maxDate = dates.length > 0 ? new Date(Math.max(...dates)) : new Date();
        const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));

        // Top vendor
        const topVendor = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount))[0];

        // Update UI - using textContent for security
        document.getElementById('totalTransactions').textContent = total.toLocaleString();
        document.getElementById('transactionPeriod').textContent = 'FY2020 - FY2025';
        document.getElementById('totalAmount').textContent = '$' + totalAmt.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('avgTransaction').textContent = 'Avg: $' + (total > 0 ? (totalAmt / total) : 0).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('uniqueVendors').textContent = vendors.toLocaleString();
        document.getElementById('topVendor').textContent = topVendor ? topVendor[0].substring(0, 30) : 'N/A';
        document.getElementById('dateRange').textContent = minDate.toLocaleDateString() + ' - ' + maxDate.toLocaleDateString();
        document.getElementById('daysCovered').textContent = daysDiff.toLocaleString() + ' days';
        document.getElementById('reviewProgress').textContent = (total > 0 ? ((reviewed / total) * 100).toFixed(1) : 0) + '%';
        document.getElementById('reviewCount').textContent = `${reviewed} of ${total} reviewed`;
        document.getElementById('highRiskCount').textContent = highRisk.length.toLocaleString();
        document.getElementById('riskAmount').textContent = '$' + highRisk.reduce((sum, t) => sum + Math.abs(t.amount), 0).toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    // ============================================================================
    // CHARTS
    // ============================================================================
    function updateCharts() {
        // Destroy existing charts
        Object.values(charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        charts = {};

        // Status chart
        const statusCounts = {
            'Mission Related': allData.filter(t => t.status === 'green').length,
            'Non-mission': allData.filter(t => t.status === 'red').length,
            'Needs Review': allData.filter(t => t.status === 'yellow').length,
            'Unreviewed': allData.filter(t => t.status === 'gray').length
        };

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12', '#95a5a6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        // Volume chart
        const monthlyData = {};
        allData.forEach(t => {
            const key = t.date.getFullYear() + '-' + String(t.date.getMonth() + 1).padStart(2, '0');
            monthlyData[key] = (monthlyData[key] || 0) + t.amount;
        });

        const sortedMonths = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));

        const volumeCtx = document.getElementById('volumeChart');
        if (volumeCtx) {
            charts.volume = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(([k]) => k),
                    datasets: [{
                        label: 'Monthly Volume',
                        data: sortedMonths.map(([, v]) => v),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        }
                    }
                }
            });
        }

        // Top vendors
        const topVendors = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount))
            .slice(0, 10);

        const vendorCtx = document.getElementById('vendorChart');
        if (vendorCtx) {
            charts.vendor = new Chart(vendorCtx, {
                type: 'bar',
                data: {
                    labels: topVendors.map(([name]) => name.substring(0, 30)),
                    datasets: [{
                        label: 'Total Amount',
                        data: topVendors.map(([, data]) => data.totalAmount),
                        backgroundColor: '#8e44ad'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        }
                    }
                }
            });
        }

        // Risk distribution
        const riskBuckets = { 'Low (0-3)': 0, 'Medium (4-6)': 0, 'High (7-10)': 0 };
        allData.forEach(t => {
            if (t.riskScore <= 3) riskBuckets['Low (0-3)']++;
            else if (t.riskScore <= 6) riskBuckets['Medium (4-6)']++;
            else riskBuckets['High (7-10)']++;
        });

        const riskCtx = document.getElementById('riskChart');
        if (riskCtx) {
            charts.risk = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskBuckets),
                    datasets: [{
                        label: 'Transaction Count',
                        data: Object.values(riskBuckets),
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }

    // ============================================================================
    // VENDOR TABLE
    // ============================================================================
    function updateVendorTable() {
        const tbody = document.getElementById('vendorTableBody');
        if (!tbody) return;

        let html = '';
        const sortedVendors = Object.entries(vendorGroups)
            .sort((a, b) => Math.abs(b[1].totalAmount) - Math.abs(a[1].totalAmount));

        sortedVendors.forEach(([vendorName, vendorData]) => {
            const vendorId = 'vendor_' + vendorName.replace(/[^a-zA-Z0-9]/g, '_');
            const escapedVendor = escapeHtml(vendorName);

            // Vendor status
            let vendorStatus = 'gray';
            if (vendorData.statuses.red > 0) vendorStatus = 'red';
            else if (vendorData.statuses.yellow > 0) vendorStatus = 'yellow';
            else if (vendorData.statuses.green > 0) vendorStatus = 'green';

            // Count docs for this vendor
            const docsCount = vendorData.transactions.reduce((sum, t) => {
                return sum + (pdfAttachments[t.id] ? pdfAttachments[t.id].length : 0);
            }, 0);

            html += `
                <tr class="vendor-row" onclick="toggleVendor('${vendorId}')" onkeydown="if(event.key==='Enter'||event.key===' ')toggleVendor('${vendorId}')" tabindex="0" role="button" aria-expanded="false" data-vendor="${vendorId}">
                    <td><input type="checkbox" class="vendor-checkbox" onclick="event.stopPropagation()"></td>
                    <td>
                        <span class="expand-icon">‚ñ∂</span>
                        <strong>${escapedVendor}</strong>
                        <span style="color: #95a5a6; font-size: 12px; margin-left: 10px;">
                            (${vendorData.count} transactions)
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 600;">
                        $${vendorData.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                    </td>
                    <td style="text-align: center;">
                        <span class="status-indicator status-${vendorStatus}"></span>
                    </td>
                    <td style="text-align: center;">
                        ${docsCount > 0 ? 'üìé ' + docsCount : '-'}
                    </td>
                    <td style="text-align: center;">
                        <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background: ${
                            vendorData.avgRisk >= 7 ? '#fee' : vendorData.avgRisk >= 4 ? '#fff3cd' : '#d4edda'
                        }; color: ${
                            vendorData.avgRisk >= 7 ? '#c0392b' : vendorData.avgRisk >= 4 ? '#856404' : '#155724'
                        };">${vendorData.avgRisk}</span>
                    </td>
                    <td></td>
                </tr>
            `;

            // Transaction rows
            vendorData.transactions.forEach(trans => {
                const review = reviewState[trans.id] || {};
                const escapedDesc = escapeHtml(trans.description.substring(0, 50));
                const escapedNotes = review.notes ? escapeHtml(review.notes.substring(0, 100)) : '';

                html += `
                    <tr class="transaction-row" data-vendor="${vendorId}" data-trans-id="${trans.id}" data-status="${trans.status}">
                        <td><input type="checkbox" class="trans-checkbox" data-trans-id="${trans.id}" onclick="event.stopPropagation(); selectTransaction('${trans.id}')"></td>
                        <td>${trans.date.toLocaleDateString()} - ${escapedDesc}</td>
                        <td style="text-align: right;">
                            $${Math.abs(trans.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </td>
                        <td style="text-align: center;">
                            <span class="status-indicator status-${trans.status}"></span>
                            ${trans.status === 'green' ? 'Green' : trans.status === 'red' ? 'Red' : trans.status === 'yellow' ? 'Yellow' : 'Unreviewed'}
                        </td>
                        <td style="text-align: center;">
                            ${pdfAttachments[trans.id] && pdfAttachments[trans.id].length > 0 ?
                                `<span style="color: #3498db; cursor: pointer;" onclick="event.stopPropagation(); showAttachments('${trans.id}')">üìé${pdfAttachments[trans.id].length}</span>` :
                                '<span style="color: #bdc3c7;">-</span>'}
                        </td>
                        <td style="text-align: center;">
                            <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; background: ${
                                trans.riskScore >= 7 ? '#fee' : trans.riskScore >= 4 ? '#fff3cd' : '#d4edda'
                            };">${trans.riskScore}</span>
                        </td>
                        <td style="text-align: center;">
                            <div class="action-buttons">
                                <button class="btn-small btn-green" onclick="quickStatus('${trans.id}', 'green', event)">‚úÖ</button>
                                <button class="btn-small btn-red" onclick="quickStatus('${trans.id}', 'red', event)">‚ùå</button>
                                <button class="btn-small btn-yellow" onclick="quickStatus('${trans.id}', 'yellow', event)">‚ö†Ô∏è</button>
                                <button class="btn-small" onclick="openReviewModal('${trans.id}', event)">üìù</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        });

        tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; padding: 40px;">No data loaded</td></tr>';
    }

    // ============================================================================
    // VENDOR INTERACTION
    // ============================================================================
    function toggleVendor(vendorId) {
        const vendorRow = document.querySelector(`.vendor-row[data-vendor="${vendorId}"]`);
        const transRows = document.querySelectorAll(`.transaction-row[data-vendor="${vendorId}"]`);

        vendorRow.classList.toggle('expanded');
        transRows.forEach(row => row.classList.toggle('visible'));

        const isExpanded = vendorRow.classList.contains('expanded');
        vendorRow.setAttribute('aria-expanded', isExpanded);
    }

    function selectTransaction(transId) {
        currentSelectedTransaction = transId;
        document.querySelectorAll('.transaction-row').forEach(row => {
            row.classList.remove('selected');
        });
        const row = document.querySelector(`.transaction-row[data-trans-id="${transId}"]`);
        if (row) row.classList.add('selected');
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAllCheckbox').checked;
        document.querySelectorAll('.trans-checkbox').forEach(cb => cb.checked = checked);
    }

    function selectAllVisible() {
        document.querySelectorAll('.transaction-row.visible .trans-checkbox').forEach(cb => cb.checked = true);
    }

    // ============================================================================
    // QUICK STATUS UPDATE
    // ============================================================================
    function quickStatus(transId, status, event) {
        if (event) event.stopPropagation();

        const trans = allData.find(t => t.id === transId);
        if (trans) {
            trans.status = status;

            reviewState[transId] = {
                ...reviewState[transId],
                status: status,
                reviewDate: new Date().toISOString(),
                quickReview: true
            };

            safeLocalStorageSet('cpaForensicReviewState', reviewState);
            groupByVendor();
            updateDashboard();
        }
    }

    // ============================================================================
    // BATCH OPERATIONS
    // ============================================================================
    function batchAccept() {
        batchUpdateStatus('green');
    }

    function batchReject() {
        batchUpdateStatus('red');
    }

    function batchUpdateStatus(status) {
        const checked = document.querySelectorAll('.trans-checkbox:checked');
        if (checked.length === 0) {
            alert('No transactions selected');
            return;
        }

        if (!confirm(`Update ${checked.length} transactions to ${status}?`)) {
            return;
        }

        checked.forEach(cb => {
            const transId = cb.dataset.transId;
            quickStatus(transId, status);
        });

        alert(`${checked.length} transactions updated`);
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================
    function navigateToNext(unreviewed = false) {
        let transactions = allData;
        if (unreviewed) {
            transactions = allData.filter(t => t.status === 'gray');
        }

        if (transactions.length === 0) {
            alert('No unreviewed transactions');
            return;
        }

        const currentIndex = currentSelectedTransaction ?
            transactions.findIndex(t => t.id === currentSelectedTransaction) : -1;

        const nextIndex = (currentIndex + 1) % transactions.length;
        selectTransaction(transactions[nextIndex].id);
    }

    function navigateToPrevious() {
        const currentIndex = currentSelectedTransaction ?
            allData.findIndex(t => t.id === currentSelectedTransaction) : -1;

        const prevIndex = currentIndex <= 0 ? allData.length - 1 : currentIndex - 1;
        selectTransaction(allData[prevIndex].id);
    }

    // ============================================================================
    // REVIEW MODAL
    // ============================================================================
    function openReviewModal(transId, event) {
        if (event) event.stopPropagation();

        currentTransactionId = transId;
        const trans = allData.find(t => t.id === transId);
        const review = reviewState[transId] || {};

        // Use textContent for security
        const infoDiv = document.getElementById('modalTransactionInfo');
        infoDiv.textContent = `${trans.vendor} | Date: ${trans.date.toLocaleDateString()} | Amount: $${Math.abs(trans.amount).toLocaleString('en-US', {minimumFractionDigits: 2})} | Risk: ${trans.riskScore}`;

        document.getElementById('reviewDecision').value = review.status || trans.status || '';
        document.getElementById('reviewCategory').value = review.category || '';
        document.getElementById('reviewNotes').value = review.notes || '';
        document.getElementById('charCount').textContent = (review.notes || '').length;

        document.getElementById('reviewModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('reviewModal').style.display = 'none';
        currentTransactionId = null;
    }

    function saveReview() {
        const status = document.getElementById('reviewDecision').value;
        const category = document.getElementById('reviewCategory').value;
        let notes = document.getElementById('reviewNotes').value;

        if (!status) {
            alert('Please select a review status');
            return;
        }

        // Validate and sanitize
        notes = notes.substring(0, 5000);

        const trans = allData.find(t => t.id === currentTransactionId);
        if (trans) {
            trans.status = status;

            reviewState[currentTransactionId] = {
                status: status,
                category: category,
                notes: notes,
                reviewDate: new Date().toISOString(),
                reviewer: 'CPA Review'
            };

            safeLocalStorageSet('cpaForensicReviewState', reviewState);
            groupByVendor();
            updateDashboard();
            closeModal();
        }
    }

    // ============================================================================
    // PDF MANAGEMENT
    // ============================================================================
    async function handleBulkPdfUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        showLoading(`Processing ${files.length} PDFs...`);

        let matchedCount = 0;
        const statusDiv = document.getElementById('pdfUploadStatus');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            try {
                // Convert to base64 for storage
                const base64 = await fileToBase64(file);

                // Match to transaction
                const matchResult = await matchPdfToTransaction(file, base64);

                if (matchResult.matched) {
                    matchedCount++;

                    if (!pdfAttachments[matchResult.transactionId]) {
                        pdfAttachments[matchResult.transactionId] = [];
                    }

                    pdfAttachments[matchResult.transactionId].push({
                        name: file.name,
                        data: base64,
                        uploadDate: new Date().toISOString(),
                        matchScore: matchResult.score
                    });
                }
            } catch (err) {
                console.error('PDF processing error:', err);
            }
        }

        safeLocalStorageSet('pdfAttachments', pdfAttachments);

        if (statusDiv) {
            statusDiv.textContent = `Matched ${matchedCount} of ${files.length} PDFs`;
        }

        updateVendorTable();
        updateDocumentStats();
        hideLoading();
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function matchPdfToTransaction(file, base64Data) {
        const fileName = file.name.toLowerCase().replace('.pdf', '');

        let bestMatch = null;
        let bestScore = 0;

        allData.forEach(trans => {
            let score = 0;
            const vendorLower = trans.vendor.toLowerCase().replace(/[^a-z0-9]/g, '');
            const cleanFileName = fileName.replace(/[^a-z0-9]/g, '');

            // Vendor name match
            if (cleanFileName.includes(vendorLower)) {
                score += 50;
            }

            // Amount match
            const amountStr = Math.abs(trans.amount).toFixed(0);
            if (cleanFileName.includes(amountStr)) {
                score += 30;
            }

            // Date match
            const month = String(trans.date.getMonth() + 1).padStart(2, '0');
            const day = String(trans.date.getDate()).padStart(2, '0');
            const year = String(trans.date.getFullYear());

            if (cleanFileName.includes(month + day) || cleanFileName.includes(year)) {
                score += 20;
            }

            if (score > bestScore && score >= 50) {
                bestScore = score;
                bestMatch = trans;
            }
        });

        if (bestMatch) {
            return {
                matched: true,
                transactionId: bestMatch.id,
                vendor: bestMatch.vendor,
                amount: bestMatch.amount,
                score: bestScore
            };
        }

        return { matched: false };
    }

    function showAttachments(transId) {
        const attachments = pdfAttachments[transId];
        if (!attachments || attachments.length === 0) {
            alert('No attachments');
            return;
        }

        let message = `Attachments (${attachments.length}):\n\n`;
        attachments.forEach((att, idx) => {
            message += `${idx + 1}. ${att.name} (Score: ${att.matchScore})\n`;
        });

        if (confirm(message + '\nDownload all?')) {
            attachments.forEach(att => {
                const link = document.createElement('a');
                link.href = att.data;
                link.download = att.name;
                link.click();
            });
        }
    }

    function updateDocumentStats() {
        const matched = Object.keys(pdfAttachments).length;
        const totalTransactions = allData.length;
        const missing = totalTransactions - matched;

        const matchedEl = document.getElementById('docsMatched');
        const unmatchedEl = document.getElementById('docsUnmatched');
        const missingEl = document.getElementById('docsMissing');

        if (matchedEl) matchedEl.textContent = matched;
        if (missingEl) missingEl.textContent = missing;
    }

    // ============================================================================
    // FORENSIC ANALYSIS
    // ============================================================================
    function runForensicAnalysis() {
        if (allData.length === 0) return;

        const alerts = [];

        // Duplicate detection
        const duplicates = findDuplicates();
        if (duplicates.length > 0) {
            alerts.push({
                level: 'high',
                message: `üö® ${duplicates.length} potential duplicate transactions detected`
            });
        }

        // Weekend clustering
        const weekendTrans = allData.filter(t => t.date.getDay() === 0 || t.date.getDay() === 6);
        if (weekendTrans.length > allData.length * 0.15) {
            alerts.push({
                level: 'medium',
                message: `‚ö†Ô∏è ${weekendTrans.length} weekend transactions (${((weekendTrans.length/allData.length)*100).toFixed(1)}%)`
            });
        }

        // Round amounts
        const roundAmounts = allData.filter(t => Math.abs(t.amount) % 1000 === 0);
        if (roundAmounts.length > allData.length * 0.20) {
            alerts.push({
                level: 'medium',
                message: `‚ö†Ô∏è ${roundAmounts.length} round-dollar transactions (${((roundAmounts.length/allData.length)*100).toFixed(1)}%)`
            });
        }

        // High-risk vendors
        const highRiskVendors = Object.entries(vendorGroups)
            .filter(([, data]) => data.avgRisk >= 7);
        if (highRiskVendors.length > 0) {
            alerts.push({
                level: 'high',
                message: `üö® ${highRiskVendors.length} high-risk vendors identified`
            });
        }

        displayForensicAlerts(alerts);
        runBenfordsLaw();
        displayDuplicates(duplicates);
    }

    function findDuplicates() {
        const duplicates = [];
        const seen = new Map();

        allData.forEach(trans => {
            const key = `${trans.vendor}_${trans.amount.toFixed(2)}_${trans.date.toDateString()}`;

            if (seen.has(key)) {
                duplicates.push({
                    original: seen.get(key),
                    duplicate: trans
                });
            } else {
                seen.set(key, trans);
            }
        });

        return duplicates;
    }

    function displayForensicAlerts(alerts) {
        const container = document.getElementById('forensicAlerts');
        if (!container) return;

        if (alerts.length === 0) {
            container.innerHTML = '<p style="color: #27ae60;">‚úÖ No major forensic alerts detected</p>';
            return;
        }

        let html = '';
        alerts.forEach(alert => {
            const escapedMsg = escapeHtml(alert.message);
            html += `<div class="alert-item ${alert.level}">${escapedMsg}</div>`;
        });

        container.innerHTML = html;
    }

    function runBenfordsLaw() {
        const firstDigits = allData
            .filter(t => Math.abs(t.amount) >= 1)
            .map(t => parseInt(String(Math.abs(t.amount))[0]));

        const counts = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
        firstDigits.forEach(d => counts[d]++);

        const actual = Object.values(counts).map(c => (c / firstDigits.length) * 100);
        const expected = [30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6];

        const benfordCtx = document.getElementById('benfordChart');
        if (benfordCtx) {
            charts.benford = new Chart(benfordCtx, {
                type: 'bar',
                data: {
                    labels: ['1','2','3','4','5','6','7','8','9'],
                    datasets: [
                        {
                            label: 'Actual',
                            data: actual,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)'
                        },
                        {
                            label: 'Expected (Benford)',
                            data: expected,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Percentage (%)' }
                        },
                        x: {
                            title: { display: true, text: 'First Digit' }
                        }
                    }
                }
            });
        }
    }

    function displayDuplicates(duplicates) {
        const container = document.getElementById('duplicateList');
        if (!container) return;

        if (duplicates.length === 0) {
            container.innerHTML = '<p style="color: #27ae60;">‚úÖ No duplicate transactions detected</p>';
            return;
        }

        let html = '<div style="font-weight: bold; margin-bottom: 10px;">Potential Duplicates:</div>';
        duplicates.forEach((dup, idx) => {
            const escapedVendor = escapeHtml(dup.original.vendor);
            html += `
                <div style="padding: 10px; margin: 5px 0; background: #fff3cd; border-radius: 4px; font-size: 13px;">
                    ${idx + 1}. ${escapedVendor} - $${Math.abs(dup.original.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                    <br><span style="font-size: 11px; color: #856404;">
                    ${dup.original.date.toLocaleDateString()} & ${dup.duplicate.date.toLocaleDateString()}
                    </span>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // ============================================================================
    // TAB SWITCHING
    // ============================================================================
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }

        if (tabName === 'forensics' && allData.length > 0) {
            runForensicAnalysis();
        }
        if (tabName === 'documents') {
            updateDocumentStats();
        }
    }

    // ============================================================================
    // EXPORT FUNCTIONS
    // ============================================================================
    function exportAuditReport() {
        if (allData.length === 0) {
            alert('No data to export');
            return;
        }

        showLoading('Generating audit report...');

        setTimeout(() => {
            const reportData = allData.map(trans => {
                const review = reviewState[trans.id] || {};
                return {
                    'Transaction ID': trans.id,
                    'Date': trans.date.toLocaleDateString(),
                    'Vendor': trans.vendor,
                    'Amount': trans.amount,
                    'Description': trans.description,
                    'Status': trans.status,
                    'Risk Score': trans.riskScore,
                    'Review Category': review.category || '',
                    'Review Notes': review.notes || '',
                    'Attachments': pdfAttachments[trans.id] ? pdfAttachments[trans.id].length : 0
                };
            });

            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
            XLSX.writeFile(wb, `Audit_Report_${new Date().toISOString().slice(0,10)}.xlsx`);

            hideLoading();
        }, 500);
    }

    function exportManagementLetter() {
        alert('Management Letter export feature coming soon');
    }

    function exportExceptionReport() {
        const exceptions = allData.filter(t => t.status === 'red' || t.riskScore >= 7);

        if (exceptions.length === 0) {
            alert('No exceptions to export');
            return;
        }

        const reportData = exceptions.map(trans => ({
            'Date': trans.date.toLocaleDateString(),
            'Vendor': trans.vendor,
            'Amount': trans.amount,
            'Status': trans.status,
            'Risk Score': trans.riskScore,
            'Description': trans.description
        }));

        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Exceptions");
        XLSX.writeFile(wb, `Exception_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function exportComplianceReport() {
        alert('Compliance Report export feature coming soon');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.id === 'reviewModal') {
            closeModal();
        }
        if (event.target.id === 'shortcutsHelp') {
            toggleShortcutsHelp();
        }
    };

    </script>
</body>
</html>
